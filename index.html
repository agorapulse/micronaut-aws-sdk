<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Vladimir Orany">
<title>Set of useful libraries for Micronaut</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css/docs.css?v=1.3.7.2" />
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Set of useful libraries for Micronaut</h1>
<div class="details">
<span id="author" class="author">Vladimir Orany</span><br>
<span id="revnumber">version 1.3.7.2</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#_aws_sdk_for_micronaut">1. AWS SDK for Micronaut</a>
<ul class="sectlevel3">
<li><a href="#_installation">1.1. Installation</a></li>
<li><a href="#_dynamodb">1.2. DynamoDB</a>
<ul class="sectlevel4">
<li><a href="#_installation_2">Installation</a></li>
<li><a href="#_declarative_services_with_service">Declarative Services with <code>@Service</code></a></li>
<li><a href="#_dynamodb_service">DynamoDB Service</a></li>
<li><a href="#_dynamodb_accelerator_dax">DynamoDB Accelerator (DAX)</a></li>
<li><a href="#_testing">Testing</a></li>
</ul>
</li>
<li><a href="#_kinesis">1.3. Kinesis</a>
<ul class="sectlevel4">
<li><a href="#_installation_3">Installation</a></li>
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_publishing_with_kinesisclient">Publishing with <code>@KinesisClient</code></a></li>
<li><a href="#_listening_with_kinesislistener">Listening with <code>@KinesisListener</code></a></li>
<li><a href="#_kinesis_service">Kinesis Service</a></li>
<li><a href="#_testing_2">Testing</a></li>
</ul>
</li>
<li><a href="#_simple_storage_service_s3">1.4. Simple Storage Service (S3)</a>
<ul class="sectlevel4">
<li><a href="#_installation_4">Installation</a></li>
<li><a href="#_configuration_2">Configuration</a></li>
<li><a href="#_simple_storage_service">Simple Storage Service</a></li>
<li><a href="#_testing_3">Testing</a></li>
</ul>
</li>
<li><a href="#_simple_email_service_ses">1.5. Simple Email Service (SES)</a>
<ul class="sectlevel4">
<li><a href="#_installation_5">Installation</a></li>
<li><a href="#_simple_email_service">Simple Email Service</a></li>
<li><a href="#_testing_4">Testing</a></li>
</ul>
</li>
<li><a href="#_simple_notification_service_sns">1.6. Simple Notification Service (SNS)</a>
<ul class="sectlevel4">
<li><a href="#_installation_6">Installation</a></li>
<li><a href="#_configuration_3">Configuration</a></li>
<li><a href="#_publishing_with_notificationclient">Publishing with <code>@NotificationClient</code></a></li>
<li><a href="#_simple_notification_service">Simple Notification Service</a></li>
<li><a href="#_testing_5">Testing</a></li>
</ul>
</li>
<li><a href="#_simple_queue_service_sqs">1.7. Simple Queue Service (SQS)</a>
<ul class="sectlevel4">
<li><a href="#_installation_7">Installation</a></li>
<li><a href="#_configuration_4">Configuration</a></li>
<li><a href="#_publishing_with_queueclient">Publishing with <code>@QueueClient</code></a></li>
<li><a href="#_simple_queue_service">Simple Queue Service</a></li>
<li><a href="#_testing_6">Testing</a></li>
</ul>
</li>
<li><a href="#_security_token_service_sts">1.8. Security Token Service (STS)</a>
<ul class="sectlevel4">
<li><a href="#_installation_8">Installation</a></li>
<li><a href="#_security_token_service">Security Token Service</a></li>
<li><a href="#_testing_7">Testing</a></li>
</ul>
</li>
<li><a href="#_websockets_for_api_gateway">1.9. WebSockets for API Gateway</a>
<ul class="sectlevel4">
<li><a href="#_installation_9">Installation</a></li>
<li><a href="#_configuration_5">Configuration</a></li>
<li><a href="#_usage">Usage</a></li>
<li><a href="#_testing_8">Testing</a></li>
</ul>
</li>
<li><a href="#_configuration_6">1.10. Configuration</a></li>
</ul>
</li>
<li><a href="#_micronaut_for_api_gateway_proxy">2. Micronaut for API Gateway Proxy</a></li>
<li><a href="#_micronaut_grails">3. Micronaut Grails</a></li>
<li><a href="#_links">1. Links</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock ribbon">
<div class="content">
<a class="image" href="https://github.com/agorapulse/micronaut-aws-sdk"><img src="images/ribbon.png" alt="ribbon"></a>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="imageblock left">
<div class="content">
<a class="image" href="https://bintray.com/agorapulse/libs/micronaut-aws-sdk/_latestVersion"><img src="https://api.bintray.com/packages/agorapulse/libs/micronaut-aws-sdk/images/download.svg" alt="download"></a>
</div>
</div>
<div class="imageblock left">
<div class="content">
<a class="image" href="https://github.com/agorapulse/micronaut-aws-sdk/actions?query=workflow%3ACheck"><img src="https://github.com/agorapulse/micronaut-aws-sdk/workflows/Check/badge.svg" alt="Build Status"></a>
</div>
</div>
<div class="imageblock left">
<div class="content">
<a class="image" href="https://coveralls.io/github/agorapulse/micronaut-aws-sdk?branch=master""><img src="https://coveralls.io/repos/github/agorapulse/micronaut-aws-sdk/badge.svg?branch=master" alt="badge"></a>
</div>
</div>
</div>
</div>
<hr>
<div class="paragraph">
<p>Set of useful libraries for <a href="http://micronaut.io">Micronaut</a>. All the libraries are available in <a href="https://bintray.com/bintray/jcenter">JCenter Maven repository</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_aws_sdk_for_micronaut">AWS SDK for Micronaut</a> - integration for <a href="#_dynamodb">DynamoDB</a>, <a href="#_kinesis">Kinesis</a>, <a href="#_simple_storage_service_s3">Simple Storage Service (S3)</a>, <a href="#_simple_email_service_ses">Simple Email Service (SES)</a>, <a href="#_simple_notification_service_sns">Simple Notification Service (SNS)</a>,  <a href="#_simple_queue_service_sqs">Simple Queue Service (SQS)</a> and <a href="#_websockets_for_api_gateway">WebSockets for API Gateway</a></p>
</li>
<li>
<p><a href="#_micronaut_for_api_gateway_proxy">Micronaut for API Gateway Proxy</a> - develop API Gateway Proxy Lambda functions using Micronaut HTTP server capabilities (currently superseded by
the official library)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aws_sdk_for_micronaut"><a class="anchor" href="#_aws_sdk_for_micronaut"></a>1. AWS SDK for Micronaut</h3>
<div class="paragraph">
<p>AWS SDK for Micronaut is a successor of <a href="https://github.com/agorapulse/grails-aws-sdk">Grails AWS SDK Plugin</a>.
If you are <a href="https://github.com/agorapulse/grails-aws-sdk">Grails AWS SDK Plugin</a> user you should find many of services familiar.</p>
</div>
<div class="paragraph">
<p>Provided integrations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_dynamodb">DynamoDB</a></p>
</li>
<li>
<p><a href="#_kinesis">Kinesis</a></p>
</li>
<li>
<p><a href="#_simple_storage_service_s3">Simple Storage Service (S3)</a></p>
</li>
<li>
<p><a href="#_simple_email_service_ses">Simple Email Service (SES)</a></p>
</li>
<li>
<p><a href="#_simple_notification_service_sns">Simple Notification Service (SNS)</a></p>
</li>
<li>
<p><a href="#_simple_queue_service_sqs">Simple Queue Service (SQS)</a></p>
</li>
<li>
<p><a href="#_security_token_service_sts">Security Token Service (STS)</a></p>
</li>
<li>
<p><a href="#_websockets_for_api_gateway">WebSockets for API Gateway</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="#_micronaut_for_api_gateway_proxy">Micronaut for API Gateway Proxy</a> is handled separately in its own library.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Key concepts of the AWS SDK for Micronaut:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fully leveraging of Micronaut best practises</p>
<div class="ulist">
<ul>
<li>
<p>Low-level API clients such as <code>AmazonDynamoDB</code> available for dependency injection</p>
</li>
<li>
<p>Declarative clients and services such as <code>@KinesisListener</code> where applicable</p>
</li>
<li>
<p>Configuration driven named service beans</p>
</li>
<li>
<p>Sensible defaults</p>
</li>
<li>
<p>Conditional beans based on presence of classes on the classpath or on the presence of specific properties</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fully leveraging existing AWS SDK configuration chains (e.g. <a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html">default credential provider chain</a>, <a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/regions/DefaultAwsRegionProviderChain.html">default region provider chain</a>)</p>
</li>
<li>
<p>Strong focus on the ease of testing</p>
<div class="ulist">
<ul>
<li>
<p>Low-level API clients such as <code>AmazonDynamoDB</code> injected by Micronaut and overridable in the tests</p>
</li>
<li>
<p>All high-level services hidden behind an interface for easy mocking in the tests</p>
</li>
<li>
<p>Declarative clients and services for easy mocking in the tests</p>
</li>
</ul>
</div>
</li>
<li>
<p>Java-enabled but Groovy is a first-class citizen</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this documentation, the high-level approaches will be discussed first before the lower-level services.</p>
</div>
<div class="sect3">
<h4 id="_installation"><a class="anchor" href="#_installation"></a>1.1. Installation</h4>
<div class="paragraph">
<p>Since  <code>1.2.8</code> see the particular subprojects for installation instruction.</p>
</div>
<div class="paragraph">
<p>Micronaut AWS SDK comes in the three compatibility versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1.3.7.2-micronaut-1.2</code> - for usage with Micronaut <code>1.2.x</code> and Grails <code>4.0.x</code> (Micronaut <code>1.0.x</code> and Micronaut <code>1.1.x</code> should also work well with these releases)</p>
</li>
<li>
<p><code>1.3.7.2</code> - for usage with the latest Micronaut  <code>1.3.x</code></p>
</li>
<li>
<p><code>1.3.7.2-micronaut-2.0</code> - for usage with upcoming Micronaut <code>2.0.x</code> version</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_dynamodb"><a class="anchor" href="#_dynamodb"></a>1.2. DynamoDB</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon DynamoDB is a fully managed NoSQL database service that provides fast and predictable performance with seamless scalability.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides two approaches to work with DynamoDB tables and entities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>High-level <a href="#_declarative_services_with_service">Declarative Services with <code>@Service</code></a></p>
</li>
<li>
<p>Middle-level <a href="#_dynamodb_service">DynamoDB Service</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_installation_2"><a class="anchor" href="#_installation_2"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-dynamodb:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-dynamodb&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_declarative_services_with_service"><a class="anchor" href="#_declarative_services_with_service"></a>Declarative Services with <code>@Service</code></h5>
<div class="paragraph">
<p>Declarative services are very similar to <a href="http://gorm.grails.org/6.1.x/hibernate/manual/#dataServices">Grails GORM Data Services</a>.
If you place <code>com.agorapulse.micronaut.aws.dynamodb.annotation.Service</code> annotation on the interface then methods
matching predefined pattern will be automatically implemented.</p>
</div>
<div class="sect5">
<h6 id="_method_signatures"><a class="anchor" href="#_method_signatures"></a>Method Signatures</h6>
<div class="paragraph">
<p>The following example shows many of available method signatures:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">@Service(DynamoDBEntity)
interface DynamoDBItemDBService {

    DynamoDBEntity get(String hash, String rangeKey)
    DynamoDBEntity load(String hash, String rangeKey)
    List&lt;DynamoDBEntity&gt; getAll(String hash, List&lt;String&gt; rangeKeys)
    List&lt;DynamoDBEntity&gt; getAll(String hash, String... rangeKeys)
    List&lt;DynamoDBEntity&gt; loadAll(String hash, List&lt;String&gt; rangeKeys)
    List&lt;DynamoDBEntity&gt; loadAll(String hash, String... rangeKeys)

    DynamoDBEntity save(DynamoDBEntity entity)
    List&lt;DynamoDBEntity&gt; saveAll(DynamoDBEntity... entities)
    List&lt;DynamoDBEntity&gt; saveAll(Iterable&lt;DynamoDBEntity&gt; entities)

    int count(String hashKey)
    int count(String hashKey, String rangeKey)

    @Query({
        query(DynamoDBEntity) {
            hash hashKey
            range {
                eq DynamoDBEntity.RANGE_INDEX, rangeKey
            }
        }
    })
    int countByRangeIndex(String hashKey, String rangeKey)

    @Query({
        query(DynamoDBEntity) {
            hash hashKey
            range { between DynamoDBEntity.DATE_INDEX, after, before }
        }
    })
    int countByDates(String hashKey, Date after, Date before)

    Flowable&lt;DynamoDBEntity&gt; query(String hashKey)
    Flowable&lt;DynamoDBEntity&gt; query(String hashKey, String rangeKey)

    @Query({
        query(DynamoDBEntity) {
            hash hashKey
            range {
                eq DynamoDBEntity.RANGE_INDEX, rangeKey
            }
            only {
                rangeIndex
            }
        }
    })
    Flowable&lt;DynamoDBEntity&gt; queryByRangeIndex(String hashKey, String rangeKey)

    @Query({
        query(DynamoDBEntity) {
            hash hashKey
            range { between DynamoDBEntity.DATE_INDEX, after, before }
        }
    })
    List&lt;DynamoDBEntity&gt; queryByDates(String hashKey, Date after, Date before)

    void delete(DynamoDBEntity entity)
    void delete(String hashKey, String rangeKey)

    @Query({
        query(DynamoDBEntity) {
            hash hashKey
            range {
                eq DynamoDBEntity.RANGE_INDEX, rangeKey
            }
        }
    })
    int deleteByRangeIndex(String hashKey, String rangeKey)

    @Query({
        query(DynamoDBEntity) {
            hash hashKey
            range { between DynamoDBEntity.DATE_INDEX, after, before }
        }
    })
    int deleteByDates(String hashKey, Date after, Date before)

    @Update({
        update(DynamoDBEntity) {
            hash hashKey
            range rangeKey
            add 'number', 1
            returnUpdatedNew { number }
        }
    })
    Number increment(String hashKey, String rangeKey)

    @Update({
        update(DynamoDBEntity) {
            hash hashKey
            range rangeKey
            add 'number', -1
            returnUpdatedNew { number }
        }
    })
    Number decrement(String hashKey, String rangeKey)

    @Scan({
        scan(DynamoDBEntity) {
            filter {
                eq DynamoDBEntity.RANGE_INDEX, foo
            }
        }
    })
    Flowable&lt;DynamoDBEntity&gt; scanAllByRangeIndex(String foo)

}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@Service(DynamoDBEntity.class)
public interface DynamoDBEntityService {

    class EqRangeIndex implements Function&lt;Map&lt;String, Object&gt;, DetachedQuery&gt; {
        public DetachedQuery apply(Map&lt;String, Object&gt; arguments) {
            return Builders.query(DynamoDBEntity.class)
                .hash(arguments.get("hashKey"))
                .range(r -&gt; r.eq(DynamoDBEntity.RANGE_INDEX, arguments.get("rangeKey")));
        }
    }

    class EqRangeProjection implements Function&lt;Map&lt;String, Object&gt;, DetachedQuery&gt; {
        public DetachedQuery apply(Map&lt;String, Object&gt; arguments) {
            return Builders.query(DynamoDBEntity.class)
                .hash(arguments.get("hashKey"))
                .range(r -&gt;
                    r.eq(DynamoDBEntity.RANGE_INDEX, arguments.get("rangeKey"))
                )
                .only(DynamoDBEntity.RANGE_INDEX);
        }
    }

    class EqRangeScan implements Function&lt;Map&lt;String, Object&gt;, DetachedScan&gt; {
        public DetachedScan apply(Map&lt;String, Object&gt; arguments) {
            return Builders.scan(DynamoDBEntity.class)
                .filter(f -&gt; f.eq(DynamoDBEntity.RANGE_INDEX, arguments.get("foo")));
        }
    }

    class BetweenDateIndex implements Function&lt;Map&lt;String, Object&gt;, DetachedQuery&gt; {
        public DetachedQuery apply(Map&lt;String, Object&gt; arguments) {
            return Builders.query(DynamoDBEntity.class)
                .hash(arguments.get("hashKey"))
                .range(r -&gt; r.between(DynamoDBEntity.DATE_INDEX, arguments.get("after"), arguments.get("before")));
        }
    }

    class IncrementNumber implements Function&lt;Map&lt;String, Object&gt;, DetachedUpdate&gt; {
        public DetachedUpdate apply(Map&lt;String, Object&gt; arguments) {
            return Builders.update(DynamoDBEntity.class)
                .hash(arguments.get("hashKey"))
                .range(arguments.get("rangeKey"))
                .add("number", 1)
                .returnUpdatedNew(DynamoDBEntity::getNumber);
        }
    }

    class DecrementNumber implements Function&lt;Map&lt;String, Object&gt;, DetachedUpdate&gt; {
        public DetachedUpdate apply(Map&lt;String, Object&gt; arguments) {
            return Builders.update(DynamoDBEntity.class)
                .hash(arguments.get("hashKey"))
                .range(arguments.get("rangeKey"))
                .add("number", -1)
                .returnUpdatedNew(DynamoDBEntity::getNumber);
        }
    }

    DynamoDBEntity get(String hash, String rangeKey);

    DynamoDBEntity load(String hash, String rangeKey);

    List&lt;DynamoDBEntity&gt; getAll(String hash, List&lt;String&gt; rangeKeys);

    List&lt;DynamoDBEntity&gt; getAll(String hash, String... rangeKeys);

    List&lt;DynamoDBEntity&gt; loadAll(String hash, List&lt;String&gt; rangeKeys);

    List&lt;DynamoDBEntity&gt; loadAll(String hash, String... rangeKeys);

    DynamoDBEntity save(DynamoDBEntity entity);

    List&lt;DynamoDBEntity&gt; saveAll(DynamoDBEntity... entities);

    List&lt;DynamoDBEntity&gt; saveAll(Iterable&lt;DynamoDBEntity&gt; entities);

    int count(String hashKey);

    int count(String hashKey, String rangeKey);

    @Query(EqRangeIndex.class)
    int countByRangeIndex(String hashKey, String rangeKey);

    @Query(BetweenDateIndex.class)
    int countByDates(String hashKey, Date after, Date before);

    Flowable&lt;DynamoDBEntity&gt; query(String hashKey);

    Flowable&lt;DynamoDBEntity&gt; query(String hashKey, String rangeKey);

    @Query(EqRangeProjection.class)
    Flowable&lt;DynamoDBEntity&gt; queryByRangeIndex(String hashKey, String rangeKey);

    @Query(BetweenDateIndex.class)
    List&lt;DynamoDBEntity&gt; queryByDates(String hashKey, Date after, Date before);

    void delete(DynamoDBEntity entity);

    void delete(String hashKey, String rangeKey);

    @Query(EqRangeIndex.class)
    int deleteByRangeIndex(String hashKey, String rangeKey);

    @Query(BetweenDateIndex.class)
    int deleteByDates(String hashKey, Date after, Date before);

    @Update(IncrementNumber.class)
    Number increment(String hashKey, String rangeKey);

    @Update(DecrementNumber.class)
    Number decrement(String hashKey, String rangeKey);

    @Scan(EqRangeScan.class)
    Flowable&lt;DynamoDBEntity&gt; scanAllByRangeIndex(String foo);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table summarizes the supported method signatures:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Basic Service Methods</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Return Type</th>
<th class="tableblock halign-left valign-top">Method Name</th>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p>
<p class="tableblock">    <code>List&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>save*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An entity, array of entities or iterable of entities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DynamoDBEntity save(DynamoDBEntity entity)</code></p>
<p class="tableblock">    <code>List&lt;DynamoDBEntity&gt; saveAll(DynamoDBEntity&#8230;&#8203; entities)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perists the entity or a list of entities and returns self</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p>
<p class="tableblock">    <code>List&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get*</code>, <code>load*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash key and optional range key, array of range keys or iterable of range keys annotated with <code>@HashKey</code> and <code>@RangeKey</code> if the argument name does not contain word <code>hash</code> or <code>range</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DynamoDBEntity load(String hashKey);</code></p>
<p class="tableblock">    <code>List&lt;DynamoDBEntity&gt; getAll(@HashKey String parentId, String&#8230;&#8203; rangeKeys);</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loads a single entity or a list of entities from the table. Range key is required for tables which defines the range key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>count*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash key and optional range key annotated with <code>@HashKey</code> and <code>@RangeKey</code> if the argument name does not contain word <code>hash</code> or <code>range</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int count(String hashKey)</code></p>
<p class="tableblock">    <code>int count(@HashKey String parentId, String rangeKey)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the items in the database. Beware, this can be very expensive operation in DynamoDB. See <a href="#_advanced_queries">Advanced Queries</a> for advanced use cases</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity or Hash key and optional range key annotated with <code>@HashKey</code> and <code>@RangeKey</code> if the argument name does not contain word <code>hash</code> or <code>range</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void delete(DynamoDBEntity entity)</code></p>
<p class="tableblock">    <code>void delete(String hashKey, String rangeKey)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deletes an item which can be specified with hash key and optional range key. See <a href="#_advanced_queries">Advanced Queries</a> for advanced use cases</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flowable&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>list*</code></p>
<p class="tableblock"><code>findAll*</code></p>
<p class="tableblock"><code>query*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity or Hash key and optional range key annotated with <code>@HashKey</code> and <code>@RangeKey</code> if the argument name does not contain word <code>hash</code> or <code>range</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flowable&lt;DynamoDBEntity&gt; query(String hashKey)</code></p>
<p class="tableblock">    <code>List&lt;DynamoDBEntity&gt; query(String hashKey, String rangeKey)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Queries for all entities with given hash key and/or range key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(contextual)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none of above)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any arguments which will be translated into arguments map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(see below)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query, scan or update. See <a href="#_advanced_queries">Advanced Queries</a>, <a href="#_scanning">Scanning</a> and <a href="#_updates">Updates</a> for advanced use cases</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Calling any of the declarative service method will create the DynamoDB table automatically if it does not exist already.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_advanced_queries"><a class="anchor" href="#_advanced_queries"></a>Advanced Queries</h6>
<div class="paragraph">
<p>DynamoDB integration does not support feature known as <a href="http://gorm.grails.org/6.0.x/hibernate/manual/index.html#finders"><em>dynamic finders</em></a>.
Instead you can annotate any method with <code>@Query</code> annotation to make it</p>
</div>
<div class="ulist">
<ul>
<li>
<p>counting method if its name begins with <code>count</code></p>
</li>
<li>
<p>batch delete method if its name begins with <code>delete</code></p>
</li>
<li>
<p>otherwise an advanced query method</p>
</li>
</ul>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">import static com.agorapulse.micronaut.aws.dynamodb.builder.Builders.*                  <i class="conum" data-value="1"></i><b>(1)</b>

@Service(DynamoDBEntity)                                                                <i class="conum" data-value="2"></i><b>(2)</b>
interface DynamoDBItemDBService {

    @Query({                                                                            <i class="conum" data-value="3"></i><b>(3)</b>
        query(DynamoDBEntity) {
            hash hashKey                                                                <i class="conum" data-value="4"></i><b>(4)</b>
            range {
                eq DynamoDBEntity.RANGE_INDEX, rangeKey                                 <i class="conum" data-value="5"></i><b>(5)</b>
            }
            only {                                                                      <i class="conum" data-value="6"></i><b>(6)</b>
                rangeIndex                                                              <i class="conum" data-value="7"></i><b>(7)</b>
            }
        }
    })
    Flowable&lt;DynamoDBEntity&gt; queryByRangeIndex(String hashKey, String rangeKey)         <i class="conum" data-value="8"></i><b>(8)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Builders</code> class provides all necessary factory methods and keywords</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate an interface with <code>@Service</code> with the type of the entity as its <code>value</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>@Query</code> annotation accepts a closure which returns a query builder (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/QueryBuilder.html">QueryBuilder</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify a hash key with <code>hash</code> method and method&#8217;s <code>hashKey</code> argument</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specify some range key criteria with the method&#8217;s <code>rangeKey</code> argument (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/RangeConditionCollector.html">RangeConditionCollector</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can limit which properties are returned from the query</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Only <code>rangeIndex</code> property will be populated in the entities returned</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The arguments have no special meaning but you can use them in the query. The method must return either <code>Flowable</code> or <code>List</code> of entities.</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@Service(DynamoDBEntity.class)                                                          <i class="conum" data-value="1"></i><b>(1)</b>
public interface DynamoDBEntityService {

    class EqRangeProjection implements Function&lt;Map&lt;String, Object&gt;, DetachedQuery&gt; {   <i class="conum" data-value="2"></i><b>(2)</b>
        public DetachedQuery apply(Map&lt;String, Object&gt; arguments) {
            return Builders.query(DynamoDBEntity.class)                                 <i class="conum" data-value="3"></i><b>(3)</b>
                .hash(arguments.get("hashKey"))                                         <i class="conum" data-value="4"></i><b>(4)</b>
                .range(r -&gt;
                    r.eq(DynamoDBEntity.RANGE_INDEX, arguments.get("rangeKey"))         <i class="conum" data-value="5"></i><b>(5)</b>
                )
                .only(DynamoDBEntity.RANGE_INDEX);                                      <i class="conum" data-value="6"></i><b>(6)</b>
        }
    }

    @Query(EqRangeProjection.class)                                                     <i class="conum" data-value="7"></i><b>(7)</b>
    Flowable&lt;DynamoDBEntity&gt; queryByRangeIndex(String hashKey, String rangeKey);        <i class="conum" data-value="8"></i><b>(8)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate an interface with <code>@Service</code> with the type of the entity as its <code>value</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define class which implements <code>QueryFunction</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify a hash key with <code>hash</code> method and method&#8217;s <code>hashKey</code> argument</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify some range key criteria with the method&#8217;s <code>rangeKey</code> argument (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/RangeConditionCollector.html">RangeConditionCollector</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Only <code>rangeIndex</code> property will be populated in the entities returned</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>@Query</code> annotation accepts a class which implements <code>Function&lt;Map&lt;String, Object&gt;, DetachedQuery&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The arguments have no special meaning but you can use them in the query using <code>arguments</code> map. The method must return either <code>Flowable</code> or <code>List</code> of entities.</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_scanning"><a class="anchor" href="#_scanning"></a>Scanning</h6>
<div class="paragraph">
<p>DynamoDB integration does not support feature known as <a href="http://gorm.grails.org/6.0.x/hibernate/manual/index.html#finders"><em>dynamic finders</em></a>.
If you need to scan the table by unindexed attributes you can annotate any method with <code>@scan</code> annotation to make it</p>
</div>
<div class="ulist">
<ul>
<li>
<p>counting method if its name begins with <code>count</code></p>
</li>
<li>
<p>otherwise an advanced query method</p>
</li>
</ul>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">import static com.agorapulse.micronaut.aws.dynamodb.builder.Builders.*                  <i class="conum" data-value="1"></i><b>(1)</b>


@Service(DynamoDBEntity)                                                                <i class="conum" data-value="2"></i><b>(2)</b>
interface DynamoDBItemDBService {


    @Scan({                                                                             <i class="conum" data-value="3"></i><b>(3)</b>
        scan(DynamoDBEntity) {
            filter {
                eq DynamoDBEntity.RANGE_INDEX, foo                                      <i class="conum" data-value="4"></i><b>(4)</b>
            }
        }
    })
    Flowable&lt;DynamoDBEntity&gt; scanAllByRangeIndex(String foo)                            <i class="conum" data-value="5"></i><b>(5)</b>


}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Builders</code> class provides all necessary factory methods and keywords</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate an interface with <code>@Service</code> with the type of the entity as its <code>value</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>@Scan</code> annotation accepts a closure which returns a scan builder (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/ScanBuilder.html">ScanBuilder</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify some filter criteria with the method&#8217;s <code>foo</code> argument (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/RangeConditionCollector.html">RangeConditionCollector</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The arguments have no special meaning but you can use them in the scan definition. The method must return either <code>Flowable</code> or <code>List</code> of entities.</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@Service(DynamoDBEntity.class)                                                          <i class="conum" data-value="1"></i><b>(1)</b>
public interface DynamoDBEntityService {

    class EqRangeScan implements Function&lt;Map&lt;String, Object&gt;, DetachedScan&gt; {          <i class="conum" data-value="2"></i><b>(2)</b>
        public DetachedScan apply(Map&lt;String, Object&gt; arguments) {
            return Builders.scan(DynamoDBEntity.class)                                  <i class="conum" data-value="3"></i><b>(3)</b>
                .filter(f -&gt; f.eq(DynamoDBEntity.RANGE_INDEX, arguments.get("foo")));   <i class="conum" data-value="4"></i><b>(4)</b>
        }
    }

    @Scan(EqRangeScan.class)                                                            <i class="conum" data-value="5"></i><b>(5)</b>
    Flowable&lt;DynamoDBEntity&gt; scanAllByRangeIndex(String foo);                           <i class="conum" data-value="6"></i><b>(6)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate an interface with <code>@Service</code> with the type of the entity as its <code>value</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define class which implements <code>ScanFunction</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify some filter criteria with the method&#8217;s <code>foo</code> argument (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/RangeConditionCollector.html">RangeConditionCollector</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>@Scan</code> annotation accepts a class which implements <code>Function&lt;Map&lt;String, Object&gt;, DetachedScan&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The arguments have no special meaning but you can use them in the scan definition. The method must return either <code>Flowable</code> or <code>List</code> of entities.</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_updates"><a class="anchor" href="#_updates"></a>Updates</h6>
<div class="paragraph">
<p>Declarative services allows you to execute fine-grained updates. Any method annotated with <code>@Update</code> will perform the update in the DynamoDB table.</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">import static com.agorapulse.micronaut.aws.dynamodb.builder.Builders.*                  <i class="conum" data-value="1"></i><b>(1)</b>


@Service(DynamoDBEntity)                                                                <i class="conum" data-value="2"></i><b>(2)</b>
interface DynamoDBItemDBService {


    @Update({                                                                           <i class="conum" data-value="3"></i><b>(3)</b>
        update(DynamoDBEntity) {
            hash hashKey                                                                <i class="conum" data-value="4"></i><b>(4)</b>
            range rangeKey                                                              <i class="conum" data-value="5"></i><b>(5)</b>
            add 'number', 1                                                             <i class="conum" data-value="6"></i><b>(6)</b>
            returnUpdatedNew { number }                                                 <i class="conum" data-value="7"></i><b>(7)</b>
        }
    })
    Number increment(String hashKey, String rangeKey)                                   <i class="conum" data-value="8"></i><b>(8)</b>


}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Builders</code> class provides all necessary factory methods and keywords</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate an interface with <code>@Service</code> with the type of the entity as its <code>value</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>@Update</code> annotation accepts a closure which returns an update builder (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/UpdateBuilder.html">UpdateBuilder</a> for full reference)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify a hash key with <code>hash</code> method and method&#8217;s <code>hashKey</code> argument</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specify a range key with <code>range</code> method and method&#8217;s <code>rangeKey</code> argument</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specify update operation - increment <code>number</code> attribute (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/UpdateBuilder.html">UpdateBuilder</a> for full reference). You may have multiple update operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Specify what should be returned from the method (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/UpdateBuilder.html">UpdateBuilder</a> for full reference).</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The arguments have no special meaning but you can use them in the scan definition. The method&#8217;s return value depends on the value returned from <code>returnUpdatedNew</code> mapper.</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@Service(DynamoDBEntity.class)                                                          <i class="conum" data-value="1"></i><b>(1)</b>
public interface DynamoDBEntityService {

    class IncrementNumber implements Function&lt;Map&lt;String, Object&gt;, DetachedUpdate&gt; {    <i class="conum" data-value="2"></i><b>(2)</b>
        public DetachedUpdate apply(Map&lt;String, Object&gt; arguments) {
            return Builders.update(DynamoDBEntity.class)                                <i class="conum" data-value="3"></i><b>(3)</b>
                .hash(arguments.get("hashKey"))                                         <i class="conum" data-value="4"></i><b>(4)</b>
                .range(arguments.get("rangeKey"))                                       <i class="conum" data-value="5"></i><b>(5)</b>
                .add("number", 1)                                                       <i class="conum" data-value="6"></i><b>(6)</b>
                .returnUpdatedNew(DynamoDBEntity::getNumber);                           <i class="conum" data-value="7"></i><b>(7)</b>
        }
    }

    @Update(IncrementNumber.class)                                                      <i class="conum" data-value="8"></i><b>(8)</b>
    Number increment(String hashKey, String rangeKey);                                  <i class="conum" data-value="9"></i><b>(9)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate an interface with <code>@Service</code> with the type of the entity as its <code>value</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define class which implements <code>Function&lt;Map&lt;String, Object&gt;, DetachedUpdate&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify a hash key with <code>hash</code> method and method&#8217;s <code>hashKey</code> argument</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify a range key with <code>range</code> method and method&#8217;s <code>rangeKey</code> argument</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specify update operation - increment <code>number</code> attribute (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/UpdateBuilder.html">UpdateBuilder</a> for full reference). You may have multiple update operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specify what should be returned from the method (see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/builder/UpdateBuilder.html">UpdateBuilder</a> for full reference).</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>@Update</code> annotation accepts a class which implements <code>Function&lt;Map&lt;String, Object&gt;, DetachedUpdate&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The arguments have no special meaning but you can use them in the scan definition. The method&#8217;s return value depends on the value returned from <code>returnUpdatedNew</code> mapper.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dynamodb_service"><a class="anchor" href="#_dynamodb_service"></a>DynamoDB Service</h5>
<div class="paragraph">
<p><code>DynamoDBService</code> provides middle-level API for working with DynamoDB tables and entites. You can obtain instance of <code>DynamoDBService</code> from
<code>DynamoDBServiceProvider</code> which can be injected to any bean.</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">DynamoDBServiceProvider provider = context.getBean(DynamoDBServiceProvider)
DynamoDBService&lt;DynamoDBEntity&gt; s = provider.findOrCreate(DynamoDBEntity)       <i class="conum" data-value="1"></i><b>(1)</b>

s.createTable()                                                                 <i class="conum" data-value="2"></i><b>(2)</b>

s.save(new DynamoDBEntity(                                                      <i class="conum" data-value="3"></i><b>(3)</b>
    parentId: '1',
    id: '1',
    rangeIndex: 'foo',
    date: REFERENCE_DATE.toDate()
))

s.get('1', '1')                                                                 <i class="conum" data-value="4"></i><b>(4)</b>

s.query('1', DynamoDBEntity.RANGE_INDEX, 'bar').count == 1                      <i class="conum" data-value="5"></i><b>(5)</b>

s.queryByDates('3', DynamoDBEntity.DATE_INDEX, [                                <i class="conum" data-value="6"></i><b>(6)</b>
    after: REFERENCE_DATE.plusDays(9).toDate(),
    before: REFERENCE_DATE.plusDays(20).toDate(),
]).count == 1

s.increment('1', '1', 'number')                                                 <i class="conum" data-value="7"></i><b>(7)</b>

s.delete(s.get('1', '1'))                                                       <i class="conum" data-value="8"></i><b>(8)</b>

s.deleteAll('1', DynamoDBEntity.RANGE_INDEX, 'bar') == 1                        <i class="conum" data-value="9"></i><b>(9)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain the instance of <code>DynamoDBService</code> from <code>DynamoDBServiceProvider</code> (provider can be injected)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create table for the entity</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Save an entity</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Load the entity by its hash and range keys</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Query the table for entities with given range index value</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Query the table for entities having date between the specified dates</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Increment a property for entity specified by hash and range keys</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Delete an entity by object reference</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Delete all entities with given range index value</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">DynamoDBServiceProvider provider = ctx.getBean(DynamoDBServiceProvider.class);
DynamoDBService&lt;DynamoDBEntity&gt; s = provider.findOrCreate(DynamoDBEntity.class);<i class="conum" data-value="1"></i><b>(1)</b>

assertNotNull(
    s.createTable(5L, 5L)                                                       <i class="conum" data-value="2"></i><b>(2)</b>
);

assertNotNull(
    s.save(createEntity("1", "1", "foo", REFERENCE_DATE.toDate()))              <i class="conum" data-value="3"></i><b>(3)</b>
);

assertNotNull(
    s.get("1", "1")                                                             <i class="conum" data-value="4"></i><b>(4)</b>
);

assertEquals(1,
    s.query("1", DynamoDBEntity.RANGE_INDEX, "bar").getCount().intValue()        <i class="conum" data-value="5"></i><b>(5)</b>
);

assertEquals(1,
    s.queryByDates(                                                             <i class="conum" data-value="6"></i><b>(6)</b>
        "3",
        DynamoDBEntity.DATE_INDEX,
        REFERENCE_DATE.plusDays(9).toDate(),
        REFERENCE_DATE.plusDays(20).toDate()
    ).getCount().intValue()
);

s.increment("1", "1", "number");                                                <i class="conum" data-value="7"></i><b>(7)</b>

s.delete(s.get("1", "1"));                                                      <i class="conum" data-value="8"></i><b>(8)</b>

assertEquals(1,
    s.deleteAll("1", DynamoDBEntity.RANGE_INDEX, "bar")                         <i class="conum" data-value="9"></i><b>(9)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain the instance of <code>DynamoDBService</code> from <code>DynamoDBServiceProvider</code> (provider can be injected)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create table for the entity</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Save an entity</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Load the entity by its hash and range keys</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Query the table for entities with given range index value</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Query the table for entities having date between the specified dates</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Increment a property for entity specified by hash and range keys</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Delete an entity by object reference</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Delete all entities with given range index value</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/dynamodb/DynamoDBService.html">DynamoDBService</a> for full reference.</p>
</div>
</div>
<div class="sect4">
<h5 id="_dynamodb_accelerator_dax"><a class="anchor" href="#_dynamodb_accelerator_dax"></a>DynamoDB Accelerator (DAX)</h5>
<div class="paragraph">
<p>You can simply enable DynamoDB Accelerator by setting the DAX endpoint as <code>aws.dax.endpoint</code> property. Every operation
performed using injected <code>AmazonDynamoDB</code>, <code>IDynamoDBMapper</code> or a data service will be performed against DAX instead of
DynamoDB tables.</p>
</div>
<div class="paragraph">
<p>Please, check <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DAX.consistency.html">DAX and DynamoDB Consistency Models</a>
article to understand the subsequence of using DAX instead of direct DynamoDB operations.</p>
</div>
<div class="paragraph">
<p>Make sure you have set up proper policy to access the DAX cluster. See <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DAX.access-control.html">DAX Access Control</a> for more information.
Following policy allow every DAX operatin on any resource. In production, you should constraint the scope to single cluster.</p>
</div>
<div class="listingblock">
<div class="title">DAX Access Policy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DaxAllowAll",
            "Effect": "Allow",
            "Action": "dax:*",
            "Resource": "*"
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing"><a class="anchor" href="#_testing"></a>Testing</h5>
<div class="paragraph">
<p>You can very easily mock any of the interfaces and declarative services but if you need close-to-production
DynamoDB integration works well with <a href="https://www.testcontainers.org/">Testcontainers</a> and <a href="https://localstack.cloud/">LocalStack</a>.</p>
</div>
<div class="paragraph">
<p>You need to add following dependencies into your build file:</p>
</div>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile group: 'org.testcontainers', name: 'localstack', version: '1.10.2'
compile group: 'org.testcontainers', name: 'spock', version: '1.10.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;localstack&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;spock&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can setup your tests like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">@Stepwise
@Testcontainers                                                                         <i class="conum" data-value="1"></i><b>(1)</b>
class DefaultDynamoDBServiceSpec extends Specification {

    @AutoCleanup ApplicationContext context                                             <i class="conum" data-value="2"></i><b>(2)</b>

    @Shared LocalStackContainer localstack = new LocalStackContainer()                  <i class="conum" data-value="3"></i><b>(3)</b>
        .withServices(LocalStackContainer.Service.DYNAMODB)

    DynamoDBService&lt;DynamoDBEntity&gt; s
    AmazonDynamoDB amazonDynamoDB
    IDynamoDBMapper mapper

    void setup() {
        amazonDynamoDB = AmazonDynamoDBClient                                           <i class="conum" data-value="4"></i><b>(4)</b>
            .builder()
            .withEndpointConfiguration(
                localstack.getEndpointConfiguration(LocalStackContainer.Service.DYNAMODB)
            )
            .withCredentials(
                localstack.defaultCredentialsProvider
            )
            .build()

        mapper = new DynamoDBMapper(amazonDynamoDB)

        context = ApplicationContext.build().build()
        context.registerSingleton(AmazonDynamoDB, amazonDynamoDB)                       <i class="conum" data-value="5"></i><b>(5)</b>
        context.registerSingleton(IDynamoDBMapper, mapper)                              <i class="conum" data-value="6"></i><b>(6)</b>
        context.start()

        DynamoDBServiceProvider provider = context.getBean(DynamoDBServiceProvider)     <i class="conum" data-value="7"></i><b>(7)</b>
        s = provider.findOrCreate(DynamoDBEntity)                                       <i class="conum" data-value="8"></i><b>(8)</b>
    }

    // test methods

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the specification with <code>@Testcontainers</code> to let Spock manage the Testcontainers for you</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code>, <code>@AutoCleanup</code> guarantees closing the context after the tests</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with only DynamoDB support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <code>AmazonDynamoDB</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Register the client using LocalStack to the application context</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register the mapper using LocalStack to the application context</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Obtain the provider bean</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Obtain <code>DynamoDBService</code> for particular DynamoDB entity</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class DynamoDBServiceTest {
    @Rule
    public LocalStackContainer localstack = new LocalStackContainer()                   <i class="conum" data-value="1"></i><b>(1)</b>
        .withServices(LocalStackContainer.Service.DYNAMODB);

    public ApplicationContext ctx;                                                      <i class="conum" data-value="2"></i><b>(2)</b>

    @Before
    public void setup() {
        AmazonDynamoDB amazonDynamoDB = AmazonDynamoDBClient                            <i class="conum" data-value="3"></i><b>(3)</b>
            .builder()
            .withEndpointConfiguration(
                localstack.getEndpointConfiguration(LocalStackContainer.Service.DYNAMODB)
            )
            .withCredentials(
                localstack.getDefaultCredentialsProvider()
            )
            .build();

        IDynamoDBMapper mapper = new DynamoDBMapper(amazonDynamoDB);

        ctx = ApplicationContext.build().build();
        ctx.registerSingleton(AmazonDynamoDB.class, amazonDynamoDB);                    <i class="conum" data-value="4"></i><b>(4)</b>
        ctx.registerSingleton(IDynamoDBMapper.class, mapper);                           <i class="conum" data-value="5"></i><b>(5)</b>
        ctx.start();
    }

    @After
    public void cleanup() {
        if (ctx != null) {                                                              <i class="conum" data-value="6"></i><b>(6)</b>
            ctx.close();
        }
    }

    @Test
    public void testSomething() {
        DynamoDBServiceProvider provider = ctx.getBean(DynamoDBServiceProvider.class);  <i class="conum" data-value="7"></i><b>(7)</b>
        DynamoDBService&lt;DynamoDBEntity&gt; s = provider.findOrCreate(DynamoDBEntity.class);<i class="conum" data-value="8"></i><b>(8)</b>

        // test code
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with only DynamoDB support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create <code>AmazonDynamoDB</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Register the client using LocalStack to the application context</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Register the mapper using LocalStack to the application context</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close the application context after test execution</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Obtain the provider bean</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Obtain <code>DynamoDBService</code> for particular DynamoDB entity</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can obtain instances of declarative client from the context as well.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_kinesis"><a class="anchor" href="#_kinesis"></a>1.3. Kinesis</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Kinesis makes it easy to collect, process, and analyze real-time, streaming data so you can get timely insights and react quickly to new information.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides three approaches to work with Kinesis streams:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>High-level <a href="#_publishing_with_kinesisclient">Publishing with <code>@KinesisClient</code></a></p>
</li>
<li>
<p>High-level <a href="#_listening_with_kinesislistener">Listening with <code>@KinesisListener</code></a></p>
</li>
<li>
<p>Middle-level <a href="#_kinesis_service">Kinesis Service</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_installation_3"><a class="anchor" href="#_installation_3"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>// for Kinesis client
compile 'com.agorapulse:micronaut-aws-sdk-kinesis:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;!-- for Kinesis client --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-kinesis&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h5>
<div class="paragraph">
<p>By default, only <code>aws.kinesis.application.name</code> and <code>aws.kinesis.listener.stream</code> are required if you decide to use <code>@KinesisListener</code>.
Otherwise you need no configuration at all but some of the configuration may be useful for you.</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="yaml">aws:
  kinesis:
    region: sa-east-1
    stream: MyStream                                                                    <i class="conum" data-value="1"></i><b>(1)</b>

    streams:                                                                            <i class="conum" data-value="2"></i><b>(2)</b>
      test:                                                                             <i class="conum" data-value="3"></i><b>(3)</b>
        stream: TestStream

    application:
      name: MyKinesisApp                                                                <i class="conum" data-value="4"></i><b>(4)</b>
    worker:
      id: rubble                                                                        <i class="conum" data-value="5"></i><b>(5)</b>
    listener:
      stream: MyStreamToConsume                                                         <i class="conum" data-value="6"></i><b>(6)</b>

    listeners:                                                                          <i class="conum" data-value="7"></i><b>(7)</b>
      test:                                                                             <i class="conum" data-value="8"></i><b>(8)</b>
        stream: TestStreamToConsume</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can specify the default stream for <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/kinesis/KinesisService.html">KinesisService</a> and <code>@KinesisClient</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can define multiple configurations</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each of the configuration can be access using <code>@Named('test') KinesisService</code> qualifier or you can define the configuration as <code>value</code> of <code>@KinesisClient('test')</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Application name is required for <code>@KinesisListner</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Optional id of the Kinesis worker (listener)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Stream to listen is required for <code>@KinesisListener</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can define multiple listeners configurations</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The name of the configuration will be used as <code>value</code> of <code>@KinesisListener('test')</code></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_publishing_with_kinesisclient"><a class="anchor" href="#_publishing_with_kinesisclient"></a>Publishing with <code>@KinesisClient</code></h5>
<div class="paragraph">
<p>If you place <code>com.agorapulse.micronaut.aws.kinesis.annotation.KinesisClient</code> annotation on the interface then methods
matching predefined pattern will be automatically implemented. Every method of <code>KinesisClient</code> puts new records into
the stream.</p>
</div>
<div class="paragraph">
<p>The following example shows many of available method signatures for publishing records:</p>
</div>
<div class="listingblock">
<div class="title">Publishing String Records</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@KinesisClient                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
interface DefaultClient {
    void putRecordString(String record);                                                <i class="conum" data-value="2"></i><b>(2)</b>

    PutRecordResult putRecord(String partitionKey, String record);                      <i class="conum" data-value="3"></i><b>(3)</b>

    void putRecordAnno(@PartitionKey String id, String record);                         <i class="conum" data-value="4"></i><b>(4)</b>

    void putRecord(String partitionKey, String record, String sequenceNumber);          <i class="conum" data-value="5"></i><b>(5)</b>

    void putRecordAnno(                                                                 <i class="conum" data-value="6"></i><b>(6)</b>
        @PartitionKey String id,
        String record,
        @SequenceNumber String sqn
    );

    void putRecordAnnoNumbers(                                                          <i class="conum" data-value="7"></i><b>(7)</b>
        @PartitionKey Long id,
        String record,
        @SequenceNumber int sequenceNumber
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@KinesisClient</code> annotation makes the interface a Kinesis client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can put String into the stream with generated UUID as partition key</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can user predefined partition key</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the name of the argument does not contain word <code>parition</code> then <code>@PartitionKey</code> annotation must to be used</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can put String into the stream with predefined partition key and a sequence number</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If the name of the sequence number argument does not contain word <code>sequence</code> then <code>@SequenceKey</code> annotation must to be used</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The type of parition key and sequence number does not matter as the value will be always converted to string</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Publishing Byte Array Records</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@KinesisClient                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
interface DefaultClient {
    void putRecordBytes(byte[] record);                                                 <i class="conum" data-value="2"></i><b>(2)</b>

    void putRecordDataByteArray(@PartitionKey String id, byte[] value);                 <i class="conum" data-value="3"></i><b>(3)</b>

    PutRecordsResult putRecords(Iterable&lt;PutRecordsRequestEntry&gt; entries);              <i class="conum" data-value="4"></i><b>(4)</b>

    PutRecordsResult putRecords(PutRecordsRequestEntry... entries);                     <i class="conum" data-value="5"></i><b>(5)</b>

    PutRecordsResult putRecord(PutRecordsRequestEntry entry);                           <i class="conum" data-value="6"></i><b>(6)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@KinesisClient</code> annotation makes the interface a Kinesis client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can put byte array into the stream, UUID as partition key will be generated</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the name of the argument does not contain word <code>parition</code> then <code>@PartitionKey</code> annotation must to be used</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can put several records wrapped into iterable of <code>PutRecordsRequestEntry</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can put several records wrapped into array of <code>PutRecordsRequestEntry</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If the single argument is of type <code>PutRecordsRequestEntry</code> then <code>PutRecordsResult</code> object is returned from the method despite only single record has been published</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Publishing Plain Old Java Objects</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@KinesisClient                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
interface DefaultClient {
    void putRecordObject(Pogo pogo);                                                    <i class="conum" data-value="2"></i><b>(2)</b>

    PutRecordsResult putRecordObjects(Pogo... pogo);                                    <i class="conum" data-value="3"></i><b>(3)</b>

    PutRecordsResult putRecordObjects(Iterable&lt;Pogo&gt; pogo);                             <i class="conum" data-value="4"></i><b>(4)</b>

    void putRecordDataObject(@PartitionKey String id, Pogo value);                      <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@KinesisClient</code> annotation makes the interface a Kinesis client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can put any object into the stream, UUID as partition key will be generated, the objects will be serialized to JSON</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can put array of any objects into the stream, UUID as partition key will be generated for each record, each object will be serialized to JSON</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can put iterable of any objects into the stream, UUID as partition key will be generated for each record, each object will be serialized to JSON</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can put any object into the stream with predefined partition key, if the name of the argument does not contain word <code>parition</code> then <code>@PartitionKey</code> annotation must to be used</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Publishing Events</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">@KinesisClient                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
interface DefaultClient {
    PutRecordResult putEvent(MyEvent event);                                            <i class="conum" data-value="2"></i><b>(2)</b>

    PutRecordsResult putEventsIterable(Iterable&lt;MyEvent&gt; events);                       <i class="conum" data-value="3"></i><b>(3)</b>

    void putEventsArrayNoReturn(MyEvent... events);                                     <i class="conum" data-value="4"></i><b>(4)</b>

    @Stream("OtherStream") PutRecordResult putEventToStream(MyEvent event);             <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@KinesisClient</code> annotation makes the interface a Kinesis client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can put object implementing <code>Event</code> into the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can put iterable of objects implementing <code>Event</code> into the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can put array of objects implementing <code>Event</code> into the stream</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Without any parameters <code>@KinesisClient</code> publishes to default stream of the default configuration but you can change it using <code>@Stream</code> annotation on the method</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The return value of the method is <code>PutRecordResult</code> or <code>PutRecordsResult</code> for putting multiple records but it can be always
omitted and replaced with <code>void</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, <code>KinesisClient</code> publishes records into the default stream defined by <code>aws.kinesis.stream</code> property.
You can switch to different configuration by changing the <code>value</code> of the annotation such as <code>@KinesisClient("other")</code> or
by setting the <code>stream</code> property of the annotation such as <code>@KinesisClient(stream = "MyStream")</code>. You can change stream
used by particular method using <code>@Stream</code> annotation as mentioned above.</p>
</div>
</div>
<div class="sect4">
<h5 id="_listening_with_kinesislistener"><a class="anchor" href="#_listening_with_kinesislistener"></a>Listening with <code>@KinesisListener</code></h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Kinesis Worker support has been discontinued. Consume Kinesis events with Lambda instead.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_kinesis_service"><a class="anchor" href="#_kinesis_service"></a>Kinesis Service</h5>
<div class="paragraph">
<p><code>KinesisService</code> provides middle-level API for creating, describing, and deleting streams. You can manage shards as well as read records
from particular shards.</p>
</div>
<div class="paragraph">
<p>Instance of <code>KinesisService</code> is created for the default Kinesis configuration and each stream configuration in <code>aws.kinesis.streams</code> map.
You should always use <code>@Named</code> qualifier when injecting <code>KinesisService</code> if you have more than one stream configuration present, e.g. <code>@Named("other") KinesisService otherService</code>.</p>
</div>
<div class="paragraph">
<p>Please, see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/kinesis/KinesisService.html">KinesisService</a> for the full reference.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_2"><a class="anchor" href="#_testing_2"></a>Testing</h5>
<div class="paragraph">
<p>You can very easily mock any of the interfaces and declarative services but if you need close-to-production
Kinesis integration works well with <a href="https://www.testcontainers.org/">Testcontainers</a> and <a href="https://localstack.cloud/">LocalStack</a>.</p>
</div>
<div class="paragraph">
<p>You need to add following dependencies into your build file:</p>
</div>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile group: 'org.testcontainers', name: 'localstack', version: '1.10.2'
compile group: 'org.testcontainers', name: 'spock', version: '1.10.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;localstack&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;spock&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can setup your tests like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">Unresolved directive in kinesis.adoc - include::/home/runner/work/micronaut-aws-sdk/micronaut-aws-sdk/subprojects/micronaut-aws-sdk-kinesis-worker/src/test/groovy/com/agorapulse/micronaut/aws/kinesis/worker/KinesisAnnotationsSpec.groovy[tags=testcontainers-header]

Unresolved directive in kinesis.adoc - include::/home/runner/work/micronaut-aws-sdk/micronaut-aws-sdk/subprojects/micronaut-aws-sdk-kinesis-worker/src/test/groovy/com/agorapulse/micronaut/aws/kinesis/worker/KinesisAnnotationsSpec.groovy[tags=testcontainers-setup]

Unresolved directive in kinesis.adoc - include::/home/runner/work/micronaut-aws-sdk/micronaut-aws-sdk/subprojects/micronaut-aws-sdk-kinesis-worker/src/test/groovy/com/agorapulse/micronaut/aws/kinesis/worker/KinesisAnnotationsSpec.groovy[tags=testcontainers-test]

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the specification with <code>@Testcontainers</code> to let Spock manage the Testcontainers for you</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@RestoreSystemProperties</code> will guarantee that system properties will be restore after the test</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with Kinesis and  DynamoDB (required by the listener) support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code>, <code>@AutoCleanup</code> guarantees closing the context after the tests</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Disable CBOR protocol for Kinesis (not supported by LocalStack/Kinesilite)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Create <code>AmazonDynamoDB</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Create <code>AmazonKinesis</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Prepare the application context with required properties and service LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>You can obtain instance of <code>KinesisService</code> from the context</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>You can obtain instance of declarative listener from the context</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>You can obtain instance of declarative client from the context</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">Unresolved directive in kinesis.adoc - include::/home/runner/work/micronaut-aws-sdk/micronaut-aws-sdk/subprojects/micronaut-aws-sdk-kinesis-worker/src/test/groovy/com/agorapulse/micronaut/aws/kinesis/worker/KinesisTest.java[tags=testcontainers-header]

Unresolved directive in kinesis.adoc - include::/home/runner/work/micronaut-aws-sdk/micronaut-aws-sdk/subprojects/micronaut-aws-sdk-kinesis-worker/src/test/groovy/com/agorapulse/micronaut/aws/kinesis/worker/KinesisTest.java[tags=testcontainers-setup]

Unresolved directive in kinesis.adoc - include::/home/runner/work/micronaut-aws-sdk/micronaut-aws-sdk/subprojects/micronaut-aws-sdk-kinesis-worker/src/test/groovy/com/agorapulse/micronaut/aws/kinesis/worker/KinesisTest.java[tags=testcontainers-test]

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with Kinesis and  DynamoDB (required by the listener) support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable CBOR protocol for Kinesis (not supported by LocalStack/Kinesilite)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <code>AmazonDynamoDB</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create <code>AmazonKinesis</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Prepare required properties</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Prepare the application context with required properties and service LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Reset CBOR protocol settings after the test</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Close the application context after the test</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>You can obtain instance of <code>KinesisService</code> from the context</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>You can obtain instance of declarative listener from the context</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>You can obtain instance of declarative client from the context</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_storage_service_s3"><a class="anchor" href="#_simple_storage_service_s3"></a>1.4. Simple Storage Service (S3)</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Simple Storage Service (Amazon S3) is an object storage service that offers industry-leading scalability, data availability, security, and performance.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides basic support for Amazon S3 using <a href="#_simple_storage_service">Simple Storage Service</a></p>
</div>
<div class="sect4">
<h5 id="_installation_4"><a class="anchor" href="#_installation_4"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-s3:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-s3&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_2"><a class="anchor" href="#_configuration_2"></a>Configuration</h5>
<div class="paragraph">
<p>You can store the name of the bucket in the configuration using <code>aws.s3.bucket</code> property. You can create additional configurations
by providing 'aws.s3.buckets' configuration map.</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="yaml">aws:
  s3:
    region: sa-east-1
    bucket: MyBucket                                                                    <i class="conum" data-value="1"></i><b>(1)</b>

    buckets:                                                                            <i class="conum" data-value="2"></i><b>(2)</b>
      test:                                                                             <i class="conum" data-value="3"></i><b>(3)</b>
        bucket: TestBucket</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can define default bucket for the service</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can define multiple configurations</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each of the configuration can be access using <code>@Named('test') SimpleStorageService</code> qualifier</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_simple_storage_service"><a class="anchor" href="#_simple_storage_service"></a>Simple Storage Service</h5>
<div class="paragraph">
<p><code>SimpleStorageService</code> provides middle-level API for managing buckets and uploading and downloading files.</p>
</div>
<div class="paragraph">
<p>Instance of <code>SimpleStorageService</code> is created for the default S3 configuration and each bucket configuration in <code>aws.s3.buckets</code> map.
You should always use <code>@Named</code> qualifier when injecting <code>SimpleStorageService</code> if you have more than one bucket configuration present, e.g. <code>@Named("test") SimpleStorageService service</code>.</p>
</div>
<div class="paragraph">
<p>Following example shows some of the most common use cases for working with S3 buckets.</p>
</div>
<div class="listingblock">
<div class="title">Creating Bucket</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">service.createBucket(MY_BUCKET);                                                <i class="conum" data-value="1"></i><b>(1)</b>

assertTrue(service.listBucketNames().contains(MY_BUCKET));                      <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create new bucket of given name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bucket is present within the list of all bucket names</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Upload File</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">File sampleContent = createFileWithSampleContent();

service.storeFile(TEXT_FILE_PATH, sampleContent);                               <i class="conum" data-value="1"></i><b>(1)</b>

assertTrue(service.exists(TEXT_FILE_PATH));                                     <i class="conum" data-value="2"></i><b>(2)</b>

Flowable&lt;S3ObjectSummary&gt; summaries = service.listObjectSummaries("foo");       <i class="conum" data-value="3"></i><b>(3)</b>
assertEquals(Long.valueOf(0L), summaries.count().blockingGet());</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Upload file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>File is uploaded</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>File is present in the summaries of all files</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Upload from <code>InputStream</code></div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">service.storeInputStream(                                                       <i class="conum" data-value="1"></i><b>(1)</b>
    KEY,
    new ByteArrayInputStream(SAMPLE_CONTENT.getBytes()),
    buildMetadata()
);

Flowable&lt;S3ObjectSummary&gt; fooSummaries = service.listObjectSummaries("foo");    <i class="conum" data-value="2"></i><b>(2)</b>
assertEquals(KEY, fooSummaries.blockingFirst().getKey());</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Upload data from stream</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Stream is uploaded</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Generate URL</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">String url = service.generatePresignedUrl(KEY, TOMORROW);                       <i class="conum" data-value="1"></i><b>(1)</b>

assertEquals(SAMPLE_CONTENT, download(url));                                    <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Generate presigned URL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Downloaded content corresponds with the expected content</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Download File</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">File dir = tmp.newFolder();
File file = new File(dir, "bar.baz");                                           <i class="conum" data-value="1"></i><b>(1)</b>

service.getFile(KEY, file);                                                     <i class="conum" data-value="2"></i><b>(2)</b>
assertTrue(file.exists());

assertEquals(SAMPLE_CONTENT, new String(Files.readAllBytes(Paths.get(file.toURI()))));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Prepare a destination file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Download the file locally</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Delete File</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">service.deleteFile(TEXT_FILE_PATH);                                             <i class="conum" data-value="1"></i><b>(1)</b>
assertFalse(service.exists(TEXT_FILE_PATH));                                    <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The file is no longer present</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Delete Bucket</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">service.deleteBucket();                                                         <i class="conum" data-value="1"></i><b>(1)</b>
assertFalse(service.listBucketNames().contains(MY_BUCKET));                     <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete bucket</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The Bucket is no longer present</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please, see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/s3/SimpleStorageService.html">SimpleStorageService</a> for the full reference.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_3"><a class="anchor" href="#_testing_3"></a>Testing</h5>
<div class="paragraph">
<p>You can very easily mock the <code>SimpleStorageService</code> but if you need close-to-production
S3 integration works well with <a href="https://www.testcontainers.org/">Testcontainers</a> and <a href="https://localstack.cloud/">LocalStack</a>.</p>
</div>
<div class="paragraph">
<p>You need to add following dependencies into your build file:</p>
</div>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile group: 'org.testcontainers', name: 'localstack', version: '1.10.2'
compile group: 'org.testcontainers', name: 'spock', version: '1.10.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;localstack&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;spock&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can setup your tests like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">@Stepwise
@Testcontainers                                                                         <i class="conum" data-value="1"></i><b>(1)</b>
class SimpleStorageServiceSpec extends Specification {

    @AutoCleanup ApplicationContext context                                             <i class="conum" data-value="2"></i><b>(2)</b>

    @Shared LocalStackContainer localstack = new LocalStackContainer()                  <i class="conum" data-value="3"></i><b>(3)</b>
        .withServices(S3)

    @Rule TemporaryFolder tmp

    AmazonS3 amazonS3
    SimpleStorageService service

    void setup() {
        amazonS3 = AmazonS3Client                                                       <i class="conum" data-value="4"></i><b>(4)</b>
            .builder()
            .withEndpointConfiguration(localstack.getEndpointConfiguration(S3))
            .withCredentials(localstack.defaultCredentialsProvider)
            .build()

        context = ApplicationContext
            .build('aws.s3.bucket': MY_BUCKET)                                          <i class="conum" data-value="5"></i><b>(5)</b>
            .build()
        context.registerSingleton(AmazonS3, amazonS3)                                   <i class="conum" data-value="6"></i><b>(6)</b>
        context.start()

        service = context.getBean(SimpleStorageService)                                 <i class="conum" data-value="7"></i><b>(7)</b>
    }

    // test methods

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the specification with <code>@Testcontainers</code> to let Spock manage the Testcontainers for you</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code>, <code>@AutoCleanup</code> guarantees closing the context after the tests</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with S3 support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <code>AmazonS3</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the default bucket</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register <code>AmazonS3</code> service running against LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can obtain instance of <code>SimpleStorageService</code> from the context</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class SimpleStorageServiceTest {

    @Rule
    public final LocalStackContainer localstack = new LocalStackContainer()            <i class="conum" data-value="1"></i><b>(1)</b>
        .withServices(S3);

    @Rule
    public final TemporaryFolder tmp = new TemporaryFolder();

    private ApplicationContext ctx;                                                     <i class="conum" data-value="2"></i><b>(2)</b>

    @Before
    public void setup() {
        AmazonS3 amazonS3 = AmazonS3Client                                              <i class="conum" data-value="3"></i><b>(3)</b>
            .builder()
            .withEndpointConfiguration(localstack.getEndpointConfiguration(S3))
            .withCredentials(localstack.getDefaultCredentialsProvider())
            .build();

        ctx = ApplicationContext
            .build(Collections.singletonMap("aws.s3.bucket", MY_BUCKET))
            .build();
        ctx.registerSingleton(AmazonS3.class, amazonS3);                                <i class="conum" data-value="4"></i><b>(4)</b>
        ctx.start();
    }

    @After
    public void cleanup() {
        if (ctx != null) {                                                              <i class="conum" data-value="5"></i><b>(5)</b>
            ctx.close();
        }
    }

    // test methods

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with Kinesis and  DynamoDB (required by the listener) support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create <code>AmazonS3</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Register <code>AmazonS3</code> service running against LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Don&#8217;t forget to close <code>ApplicationContext</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_email_service_ses"><a class="anchor" href="#_simple_email_service_ses"></a>1.5. Simple Email Service (SES)</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Simple Email Service (Amazon SES) is a cloud-based email sending service designed to help digital marketers and application developers send marketing, notification, and transactional emails. It is a reliable, cost-effective service for businesses of all sizes that use email to keep in contact with their customers.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides basic support for Amazon SES using <a href="#_simple_email_service">Simple Email Service</a></p>
</div>
<div class="sect4">
<h5 id="_installation_5"><a class="anchor" href="#_installation_5"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-ses:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-ses&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_simple_email_service"><a class="anchor" href="#_simple_email_service"></a>Simple Email Service</h5>
<div class="paragraph">
<p><code>SimpleEmailService</code> provides DSL for creating and sending simple emails with attachments. As the other services,
it uses default credentials chain to obtain the credentials.</p>
</div>
<div class="paragraph">
<p>Following example shows how to send an email with attachment.</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">package com.agorapulse.micronaut.aws.ses

import com.amazonaws.services.simpleemail.AmazonSimpleEmailService
import com.amazonaws.services.simpleemail.model.SendRawEmailRequest
import com.amazonaws.services.simpleemail.model.SendRawEmailResult
import org.junit.Rule
import org.junit.rules.TemporaryFolder
import spock.lang.Specification
import spock.lang.Subject

/**
 * Tests for sending emails with Groovy.
 */
class SendEmailSpec extends Specification {

    AmazonSimpleEmailService simpleEmailService = Mock(AmazonSimpleEmailService)

    @Rule
    TemporaryFolder tmp = new TemporaryFolder()

    @Subject
    SimpleEmailService service = new DefaultSimpleEmailService(
        simpleEmailService,
        new SimpleEmailServiceConfiguration()
    )

    void "send email"() {
        given:
            File file = tmp.newFile('test.pdf')
            file.text = 'not a real PDF'
            String thePath = file.canonicalPath
        when:
            EmailDeliveryStatus status = service.send {                                 <i class="conum" data-value="1"></i><b>(1)</b>
                subject 'Hi Paul'                                                       <i class="conum" data-value="2"></i><b>(2)</b>
                from 'subscribe@groovycalamari.com'                                     <i class="conum" data-value="3"></i><b>(3)</b>
                to 'me@sergiodelamo.com'                                                <i class="conum" data-value="4"></i><b>(4)</b>
                htmlBody '&lt;p&gt;This is an example body&lt;/p&gt;'                               <i class="conum" data-value="5"></i><b>(5)</b>
                attachment {                                                            <i class="conum" data-value="6"></i><b>(6)</b>
                    filepath thePath                                                    <i class="conum" data-value="7"></i><b>(7)</b>
                    filename 'test.pdf'                                                 <i class="conum" data-value="8"></i><b>(8)</b>
                    mimeType 'application/pdf'                                          <i class="conum" data-value="9"></i><b>(9)</b>
                    description 'An example pdf'                                        <i class="conum" data-value="10"></i><b>(10)</b>
                }
            }

        then:
            status == EmailDeliveryStatus.STATUS_DELIVERED

            simpleEmailService.sendRawEmail(_) &gt;&gt; { SendRawEmailRequest request -&gt;
                return new SendRawEmailResult().withMessageId('foobar')
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building an email</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define subject of the email</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the from address</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define one or more recipients</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define HTML body (alternatively you can declare plain text body as well)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Build an attachment</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Define the location of the file to be sent</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Define the file name (optional - deduced from the file)</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Define the mime type (usually optional - deduced from the file)</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Define the description of the file (optional)</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">package com.agorapulse.micronaut.aws.ses;

import com.amazonaws.services.simpleemail.AmazonSimpleEmailService;
import com.amazonaws.services.simpleemail.model.SendRawEmailResult;
import org.junit.Assert;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TemporaryFolder;
import org.mockito.Mockito;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.util.Collections;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

/**
 * Tests for sending emails with Java.
 */
public class SendEmailTest {

    @Rule public TemporaryFolder tmp = new TemporaryFolder();

    private AmazonSimpleEmailService simpleEmailService = mock(AmazonSimpleEmailService.class);

    private SimpleEmailService service = new DefaultSimpleEmailService(
        simpleEmailService,
        new SimpleEmailServiceConfiguration()
    );

    @Test
    public void testSendEmail() throws IOException {
        when(simpleEmailService.sendRawEmail(Mockito.any()))
            .thenReturn(new SendRawEmailResult().withMessageId("foobar"));

        File file = tmp.newFile("test.pdf");
        Files.write(file.toPath(), Collections.singletonList("not a real PDF"));
        String filepath = file.getCanonicalPath();

        EmailDeliveryStatus status = service.send(e -&gt;                                  <i class="conum" data-value="1"></i><b>(1)</b>
            e.subject("Hi Paul")                                                        <i class="conum" data-value="2"></i><b>(2)</b>
                .from("subscribe@groovycalamari.com")                                   <i class="conum" data-value="3"></i><b>(3)</b>
                .to("me@sergiodelamo.com")                                              <i class="conum" data-value="4"></i><b>(4)</b>
                .htmlBody("&lt;p&gt;This is an example body&lt;/p&gt;")                             <i class="conum" data-value="5"></i><b>(5)</b>
                .attachment(a -&gt;                                                        <i class="conum" data-value="6"></i><b>(6)</b>
                    a.filepath(filepath)                                                <i class="conum" data-value="7"></i><b>(7)</b>
                        .filename("test.pdf")                                           <i class="conum" data-value="8"></i><b>(8)</b>
                        .mimeType("application/pdf")                                    <i class="conum" data-value="9"></i><b>(9)</b>
                        .description("An example pdf")                                  <i class="conum" data-value="10"></i><b>(10)</b>
                )
        );

        Assert.assertEquals(EmailDeliveryStatus.STATUS_DELIVERED, status);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start building an email</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define subject of the email</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the from address</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define one or more recipients</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define HTML body (alternatively you can declare plain text body as well)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Build an attachment</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Define the location of the file to be sent</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Define the file name (optional - deduced from the file)</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Define the mime type (usually optional - deduced from the file)</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Define the description of the file (optional)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please, see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/ses/SimpleEmailService.html">SimpleEmailService</a> for the full reference.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_4"><a class="anchor" href="#_testing_4"></a>Testing</h5>
<div class="paragraph">
<p>It is recommended just to mock the <code>SimpleEmailService</code> in your tests as it only contains single abstract method.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_notification_service_sns"><a class="anchor" href="#_simple_notification_service_sns"></a>1.6. Simple Notification Service (SNS)</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Simple Notification Service (SNS) is a highly available, durable, secure, fully managed pub/sub messaging service that enables you to decouple microservices, distributed systems, and serverless applications.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides two approaches to work with Simple Notification Service topics:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>High-level <a href="#_publishing_with_notificationclient">Publishing with <code>@NotificationClient</code></a></p>
</li>
<li>
<p>Middle-level <a href="#_simple_notification_service">Simple Notification Service</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_installation_6"><a class="anchor" href="#_installation_6"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-sns:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-sns&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_3"><a class="anchor" href="#_configuration_3"></a>Configuration</h5>
<div class="paragraph">
<p>No configuration is required but some of the configuration properties may be useful for you.</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="yaml">aws:
  sns:
    region: sa-east-1
    topic: MyTopic                                                                      <i class="conum" data-value="1"></i><b>(1)</b>
    ios:
      arn: 'arn:aws:sns:eu-west-1:123456789:app/APNS/my-ios-app'                        <i class="conum" data-value="2"></i><b>(2)</b>
    android:
      arn: 'arn:aws:sns:eu-west-1:123456789:app/GCM/my-android-app'                     <i class="conum" data-value="3"></i><b>(3)</b>
    amazon:
      arn: 'arn:aws:sns:eu-west-1:123456789:app/ADM/my-amazon-app'                      <i class="conum" data-value="4"></i><b>(4)</b>


    topics:                                                                             <i class="conum" data-value="5"></i><b>(5)</b>
      test:                                                                             <i class="conum" data-value="6"></i><b>(6)</b>
        topic: TestTopic</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can specify the default topic for <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/sns/SimpleNotificationService.html">SimpleNotificationService</a> and <code>@NotificationClient</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Amazon Resource Name for the iOS application mobile push</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Amazon Resource Name for the Android application mobile push</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Amazon Resource Name for the Amazon application mobile push</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can define multiple configurations</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Each of the configuration can be access using <code>@Named('test') SimpleNotificationService</code> qualifier or you can define the configuration as <code>value</code> of <code>@NotificationClient('test')</code></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_publishing_with_notificationclient"><a class="anchor" href="#_publishing_with_notificationclient"></a>Publishing with <code>@NotificationClient</code></h5>
<div class="paragraph">
<p>If you place <code>com.agorapulse.micronaut.aws.sns.annotation.NotificationClient</code> annotation on the interface then methods
matching predefined pattern will be automatically implemented. Methods containing word <code>sms</code> will send text messages.
Other methods of <code>NotificationClient</code> will publish new messages into the topic.</p>
</div>
<div class="paragraph">
<p>The following example shows many of available method signatures for publishing records:</p>
</div>
<div class="listingblock">
<div class="title">Publishing String Records</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">package com.agorapulse.micronaut.aws.sns;

import com.agorapulse.micronaut.aws.sns.annotation.NotificationClient;
import com.agorapulse.micronaut.aws.sns.annotation.Topic;

import java.util.Map;

@NotificationClient                                                                     <i class="conum" data-value="1"></i><b>(1)</b>
interface DefaultClient {

    String OTHER_TOPIC = "OtherTopic";

    @Topic("OtherTopic") String publishMessageToDifferentTopic(Pogo pogo);              <i class="conum" data-value="2"></i><b>(2)</b>

    String publishMessage(Pogo message);                                                <i class="conum" data-value="3"></i><b>(3)</b>
    String publishMessage(String subject, Pogo message);                                <i class="conum" data-value="4"></i><b>(4)</b>
    String publishMessage(String message);                                              <i class="conum" data-value="5"></i><b>(5)</b>
    String publishMessage(String subject, String message);

    String sendSMS(String phoneNumber, String message);                                 <i class="conum" data-value="6"></i><b>(6)</b>
    String sendSms(String phoneNumber, String message, Map attributes);                 <i class="conum" data-value="7"></i><b>(7)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@NotificationClient</code> annotation makes the interface a SNS client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can specify to which topic is the message published using <code>@Topic</code> annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can publish any object which can be converted into JSON.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can add additional subject to published message (only useful for few protocols, e.g. email)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can publish a string message</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can send SMS using the word <code>SMS</code> in the name of the method. One argument must be phone number and its name must contain the word <code>number</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can provide additional attributes for the SMS message</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The return value of the methods is message id returned by AWS.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, <code>NotificationClient</code> publishes messages into the default topic defined by <code>aws.sns.topic</code> property.
You can switch to different configuration by changing the <code>value</code> of the annotation such as <code>@NotificationClient("other")</code> or
by setting the <code>topic</code> property of the annotation such as <code>@NotificationClient(topic = "SomeTopic")</code>. You can change topic
used by particular method using <code>@Topic</code> annotation as mentioned above.</p>
</div>
</div>
<div class="sect4">
<h5 id="_simple_notification_service"><a class="anchor" href="#_simple_notification_service"></a>Simple Notification Service</h5>
<div class="paragraph">
<p><code>SimpleNotificationService</code> provides middle-level API for creating, describing, and deleting topics. You can manage applications, endpoints and devices.
You can send messages and notifications.</p>
</div>
<div class="paragraph">
<p>Instance of <code>SimpleNotificationService</code> is created for the default SNS configuration and each topics configuration in <code>aws.sns.topics</code> map.
You should always use <code>@Named</code> qualifier when injecting <code>SimpleNotificationService</code> if you have more than one topic configuration present, e.g. <code>@Named("other") SimpleNotificationService otherService</code>.</p>
</div>
<div class="paragraph">
<p>Following example shows some of the most common use cases for working with Amazon SNS.</p>
</div>
<div class="sect5">
<h6 id="_working_with_topics"><a class="anchor" href="#_working_with_topics"></a>Working with Topics</h6>
<div class="listingblock">
<div class="title">Creating Topic</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">String topicArn = service.createTopic(TEST_TOPIC);                              <i class="conum" data-value="1"></i><b>(1)</b>

Topic found = service.listTopics().filter(t -&gt;                                  <i class="conum" data-value="2"></i><b>(2)</b>
    t.getTopicArn().endsWith(TEST_TOPIC)
).blockingFirst();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create new topic of given name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The topic is present within the list of all topics' names</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Subscribe to Topic</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">String subArn = service.subscribeTopicWithEmail(topicArn, EMAIL);               <i class="conum" data-value="1"></i><b>(1)</b>

String messageId = service.publishMessageToTopic(                               <i class="conum" data-value="2"></i><b>(2)</b>
    topicArn,
    "Test Email",
    "Hello World"
);

service.unsubscribeTopic(subArn);                                               <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Subscribe to the topic with an email (there are more variants of this method to subscribe to most common protocols such as HTTP(S) endpoints, SQS, &#8230;&#8203;)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Publish message to the topic</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the subscription ARN to unsubscribe from the topic</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Delete Topic</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">service.deleteTopic(topicArn);                                                  <i class="conum" data-value="1"></i><b>(1)</b>

Long zero = service.listTopics().filter(t -&gt;                                    <i class="conum" data-value="2"></i><b>(2)</b>
    t.getTopicArn().endsWith(TEST_TOPIC)
).count().blockingGet();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete the topic</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The topic is no longer present within the list of all topics' names</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_working_with_applications"><a class="anchor" href="#_working_with_applications"></a>Working with Applications</h6>
<div class="listingblock">
<div class="title">Working with Applications</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">String appArn = service.createPlatformApplication("my-app", SimpleNotificationService.PlatformType.GCM, null, API_KEY);        <i class="conum" data-value="1"></i><b>(1)</b>

String endpoint = service.createPlatformEndpoint(appArn, DEVICE_TOKEN, DATA);    <i class="conum" data-value="2"></i><b>(2)</b>

String jsonMessage = "{\"data\", \"{\"foo\": \"some bar\"}\", \"notification\", \"{\"title\": \"some title\", \"body\": \"some body\"}\"}";

String msgId = service.sendNotification(endpoint, SimpleNotificationService.PlatformType.GCM, jsonMessage);  <i class="conum" data-value="3"></i><b>(3)</b>

service.validateDeviceToken(appArn, endpoint, DEVICE_TOKEN, DATA); <i class="conum" data-value="4"></i><b>(4)</b>

service.unregisterDevice(endpoint);                                             <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create new Android application (more platforms available)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register Android device (more platforms available)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Send Android notification (more platforms available)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Validate Android device</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Unregister device</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_sending_sms"><a class="anchor" href="#_sending_sms"></a>Sending SMS</h6>
<div class="listingblock">
<div class="title">Sending SMS</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">Map&lt;Object, Object&gt; attrs = Collections.emptyMap();
String msgId = service.sendSMSMessage(PHONE_NUMBER, "Hello World", attrs);      <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send a message to the phone number</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please, see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/sns/SimpleNotificationService.html">SimpleNotificationService</a> for the full reference.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_5"><a class="anchor" href="#_testing_5"></a>Testing</h5>
<div class="paragraph">
<p>You can very easily mock any of the interfaces and declarative services but if you need close-to-production
SNS integration works well with <a href="https://www.testcontainers.org/">Testcontainers</a> and <a href="https://localstack.cloud/">LocalStack</a>.</p>
</div>
<div class="paragraph">
<p>You need to add following dependencies into your build file:</p>
</div>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile group: 'org.testcontainers', name: 'localstack', version: '1.10.2'
compile group: 'org.testcontainers', name: 'spock', version: '1.10.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;localstack&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;spock&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can setup your tests like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">@Testcontainers                                                                         <i class="conum" data-value="1"></i><b>(1)</b>
class SimpleNotificationServiceSpec extends Specification {


    @Shared LocalStackContainer localstack = new LocalStackContainer('0.8.10')          <i class="conum" data-value="2"></i><b>(2)</b>
        .withServices(SNS)

    @AutoCleanup ApplicationContext context                                             <i class="conum" data-value="3"></i><b>(3)</b>

    SimpleNotificationService service

    void setup() {
        AmazonSNS sns = AmazonSNSClient                                                 <i class="conum" data-value="4"></i><b>(4)</b>
            .builder()
            .withEndpointConfiguration(localstack.getEndpointConfiguration(SNS))
            .withCredentials(localstack.defaultCredentialsProvider)
            .build()

        context = ApplicationContext.build('aws.sns.topic', TEST_TOPIC).build()         <i class="conum" data-value="5"></i><b>(5)</b>
        context.registerSingleton(AmazonSNS, sns)
        context.start()

        service = context.getBean(SimpleNotificationService)                            <i class="conum" data-value="6"></i><b>(6)</b>
    }

    // tests

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the specification with <code>@Testcontainers</code> to let Spock manage the Testcontainers for you</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with SNS support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code>, <code>@AutoCleanup</code> guarantees closing the context after the tests</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <code>AmazonSNS</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Prepare the application context with required properties and service using LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can obtain instance of <code>SimpleNotificationService</code> from the context</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">class SimpleNotificationServiceTest {

    public ApplicationContext context;                                                  <i class="conum" data-value="1"></i><b>(1)</b>

    public SimpleNotificationService service;

    @Rule
    public LocalStackContainer localstack = new LocalStackContainer("0.8.10")            <i class="conum" data-value="2"></i><b>(2)</b>
        .withServices(SNS);

    @Before
    public void setup() {
        AmazonSNS amazonSNS = AmazonSNSClient                                           <i class="conum" data-value="3"></i><b>(3)</b>
            .builder()
            .withEndpointConfiguration(localstack.getEndpointConfiguration(SNS))
            .withCredentials(localstack.getDefaultCredentialsProvider())
            .build();


        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();                               <i class="conum" data-value="4"></i><b>(4)</b>
        properties.put("aws.sns.topic", TEST_TOPIC);


        context = ApplicationContext.build(properties).build();                         <i class="conum" data-value="5"></i><b>(5)</b>
        context.registerSingleton(AmazonSNS.class, amazonSNS);
        context.start();

        service = context.getBean(SimpleNotificationService.class);
    }

    @After
    public void cleanup() {
        if (context != null) {
            context.close();                                                            <i class="conum" data-value="6"></i><b>(6)</b>
        }
    }

    // tests

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with SNS support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create <code>AmazonSNS</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Prepare required properties</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Prepare the application context with required properties and service LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Close the application context after the test</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_queue_service_sqs"><a class="anchor" href="#_simple_queue_service_sqs"></a>1.7. Simple Queue Service (SQS)</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Simple Queue Service (SQS) is a fully managed message queuing service that enables you to decouple and scale microservices, distributed systems, and serverless applications. SQS eliminates the complexity and overhead associated with managing and operating message oriented middleware, and empowers developers to focus on differentiating work.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides two approaches to work with Simple Queue Service queues:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>High-level <a href="#_publishing_with_queueclient">Publishing with <code>@QueueClient</code></a></p>
</li>
<li>
<p>Middle-level <a href="#_simple_queue_service">Simple Queue Service</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_installation_7"><a class="anchor" href="#_installation_7"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-sqs:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-sqs&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_4"><a class="anchor" href="#_configuration_4"></a>Configuration</h5>
<div class="paragraph">
<p>No configuration is required but some of the configuration properties may be useful for you.</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="yaml">aws:
  sqs:
    region: sa-east-1
    # related to service behaviour
    queueNamePrefix: 'vlad_'                                                            <i class="conum" data-value="1"></i><b>(1)</b>
    autoCreateQueue: false                                                              <i class="conum" data-value="2"></i><b>(2)</b>
    cache: false                                                                        <i class="conum" data-value="3"></i><b>(3)</b>

    # related to default queue
    queue: MyQueue                                                                      <i class="conum" data-value="4"></i><b>(4)</b>
    fifo: true                                                                          <i class="conum" data-value="5"></i><b>(5)</b>
    delaySeconds: 0                                                                     <i class="conum" data-value="6"></i><b>(6)</b>
    messageRetentionPeriod: 345600                                                      <i class="conum" data-value="7"></i><b>(7)</b>
    maximumMessageSize: 262144                                                          <i class="conum" data-value="8"></i><b>(8)</b>
    visibilityTimeout: 30                                                               <i class="conum" data-value="9"></i><b>(9)</b>

    queues:                                                                             <i class="conum" data-value="10"></i><b>(10)</b>
      test:                                                                             <i class="conum" data-value="11"></i><b>(11)</b>
        queue: TestQueue</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Queue prefix is prepended to every queue name (may be useful for local development)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Whether to create any missing queue automatically (default <code>false</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Whether to first fetch all queues and set up queue to url cache first time the service is prompted for the queue URL (default <code>false</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can specify the default topic for <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/sqs/SimpleQueueService.html">SimpleQueueService</a> and <code>@QueueClient</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Whether the newly created queues are supposed to be <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/FIFO-queues.html">FIFO queues</a> (default <code>false</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The length of time, in seconds, for which the delivery of all messages in the queue is delayed. Valid values: An integer from <code>0</code> to <code>900</code> (15 minutes). Default: <code>0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The length of time, in seconds, for which Amazon SQS retains a message. Valid values: An integer representing seconds, from <code>60</code> (1 minute) to <code>1,209,600</code> (14 days). Default: <code>345,600</code> (4 days).</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The limit of how many bytes a message can contain before Amazon SQS rejects it. Valid values: An integer from <code>1,024</code> bytes (1 KiB) up to <code>262,144</code> bytes (256 KiB). Default: <code>262,144</code> (256 KiB).</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The visibility timeout for the queue, in seconds. Valid values: an integer from <code>0</code> to <code>43,200</code> (12 hours). Default: <code>30</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>You can define multiple configurations</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Each of the configuration can be access using <code>@Named('test') SimpleNotificationService</code> qualifier or you can define the configuration as <code>value</code> of <code>@NotificationClient('test')</code></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_publishing_with_queueclient"><a class="anchor" href="#_publishing_with_queueclient"></a>Publishing with <code>@QueueClient</code></h5>
<div class="paragraph">
<p>If you place <code>com.agorapulse.micronaut.aws.sqs.annotation.QueueClient</code> annotation on the interface then methods
matching predefined pattern will be automatically implemented. Methods containing word <code>delete</code> will delete queue messages.
Other methods of <code>QueueClient</code> will publish new records into the queue.</p>
</div>
<div class="paragraph">
<p>The following example shows many of available method signatures for publishing records:</p>
</div>
<div class="listingblock">
<div class="title">Publishing String Records</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">package com.agorapulse.micronaut.aws.sqs;

import com.agorapulse.micronaut.aws.sqs.annotation.Queue;
import com.agorapulse.micronaut.aws.sqs.annotation.QueueClient;

@QueueClient                                                                            <i class="conum" data-value="1"></i><b>(1)</b>
interface DefaultClient {

    @Queue(value = "OtherQueue", group = "SomeGroup")
    String sendMessageToQueue(String message);                                          <i class="conum" data-value="2"></i><b>(2)</b>

    String sendMessage(Pogo message);                                                   <i class="conum" data-value="3"></i><b>(3)</b>

    String sendMessage(byte[] record);                                                  <i class="conum" data-value="4"></i><b>(4)</b>

    String sendMessage(String record);                                                  <i class="conum" data-value="5"></i><b>(5)</b>

    String sendMessage(String record, int delay);                                       <i class="conum" data-value="6"></i><b>(6)</b>

    String sendMessage(String record, String group);                                    <i class="conum" data-value="7"></i><b>(7)</b>

    String sendMessage(String record, int delay, String group);                         <i class="conum" data-value="8"></i><b>(8)</b>

    void deleteMessage(String messageId);                                               <i class="conum" data-value="9"></i><b>(9)</b>

    String OTHER_QUEUE = "OtherQueue";
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@QueueClient</code> annotation makes the interface a SQS client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can specify to which queue is the message published using <code>@Queue</code> annotation, you can also specify the <code>group</code> for FIFO queues</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can publish any record object which can be converted into JSON.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can publish a byte array record</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can publish a string record</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can publish a string with custom delay</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can publish a string with custom FIFO queue group</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>You can publish a string with custom delay and FIFO queue group</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>You can delete published message using the message ID if the</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The return value of the publishing methods is message id returned by AWS.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, <code>QueueClient</code> publishes recoreds into the default queue defined by <code>aws.sqs.queue</code> property.
You can switch to different configuration by changing the <code>value</code> of the annotation such as <code>@QueueClient("other")</code> or
by setting the <code>queue</code> property of the annotation such as <code>@QueueClient(queue = "SomeQueue")</code>. You can change queue
used by particular method using <code>@Queue</code> annotation as mentioned above.</p>
</div>
</div>
<div class="sect4">
<h5 id="_simple_queue_service"><a class="anchor" href="#_simple_queue_service"></a>Simple Queue Service</h5>
<div class="paragraph">
<p><code>SimpleQueuenService</code> provides middle-level API for creating, describing, and deleting queues. It allows to publish, receive and delete records.</p>
</div>
<div class="paragraph">
<p>Instance of <code>SimpleQueueService</code> is created for the default SQS configuration and each queue configuration in <code>aws.sqs.queues</code> map.
You should always use <code>@Named</code> qualifier when injecting <code>SimpleQueueService</code> if you have more than one topic configuration present, e.g. <code>@Named("other") SimpleQueueService otherService</code>.</p>
</div>
<div class="paragraph">
<p>Following example shows some of the most common use cases for working with Amazon SQS.</p>
</div>
<div class="listingblock">
<div class="title">Creating Queue</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">String queueUrl = service.createQueue(TEST_QUEUE);                              <i class="conum" data-value="1"></i><b>(1)</b>

assertTrue(service.listQueueUrls().contains(queueUrl));                         <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create new queue of given name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The queue URL is present within the list of all queues' URLs</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Describing Queue Attributes</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">Map&lt;String, String&gt; queueAttributes = service.getQueueAttributes(TEST_QUEUE);   <i class="conum" data-value="1"></i><b>(1)</b>

assertEquals("0", queueAttributes.get("DelaySeconds"));                         <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Fetch queue&#8217;s attributes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can read the queue&#8217;s attributes from the map</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Delete Queue</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">service.deleteQueue(TEST_QUEUE);                                                <i class="conum" data-value="1"></i><b>(1)</b>

assertFalse(service.listQueueUrls().contains(queueUrl));                        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delete queue</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The queue URL is no longer present within the list of all queues' URLs</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Working with Messages</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="java">String msgId = service.sendMessage(DATA);                                       <i class="conum" data-value="1"></i><b>(1)</b>

assertNotNull(msgId);

List&lt;Message&gt; messages = service.receiveMessages();                             <i class="conum" data-value="2"></i><b>(2)</b>
Message first = messages.get(0);

assertEquals(DATA, first.getBody());                                            <i class="conum" data-value="3"></i><b>(3)</b>
assertEquals(msgId, first.getMessageId());
assertEquals(1, messages.size());

service.deleteMessage(msgId);                                                   <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send a message</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Receive messages from the queue (in another application)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Read message body</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Developers are responsible to delete the message from the queue themselves</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try to use AWS Lambda functions triggered by SQS messages to handle incoming SQS messages instead of implementing
complex message handling logic yourselves.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please, see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/sqs/SimpleQueueService.html">SimpleQueueService</a> for the full reference.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_6"><a class="anchor" href="#_testing_6"></a>Testing</h5>
<div class="paragraph">
<p>You can very easily mock any of the interfaces and declarative services but if you need close-to-production
SQS integration works well with <a href="https://www.testcontainers.org/">Testcontainers</a> and <a href="https://localstack.cloud/">LocalStack</a>.</p>
</div>
<div class="paragraph">
<p>You need to add following dependencies into your build file:</p>
</div>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile group: 'org.testcontainers', name: 'localstack', version: '1.10.2'
compile group: 'org.testcontainers', name: 'spock', version: '1.10.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;localstack&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;
    &lt;artifactId&gt;spock&lt;/artifactId&gt;
    &lt;version&gt;1.10.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can setup your tests like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">@Testcontainers                                                                         <i class="conum" data-value="1"></i><b>(1)</b>
@RestoreSystemProperties                                                                <i class="conum" data-value="2"></i><b>(2)</b>
class SimpleQueueServiceSpec extends Specification {


    @Shared LocalStackContainer localstack = new LocalStackContainer('0.8.10')          <i class="conum" data-value="3"></i><b>(3)</b>
        .withServices(SQS)

    @AutoCleanup ApplicationContext context                                             <i class="conum" data-value="4"></i><b>(4)</b>

    SimpleQueueService service

    void setup() {
        System.setProperty('com.amazonaws.sdk.disableCbor', 'true')                     <i class="conum" data-value="5"></i><b>(5)</b>
        AmazonSQS sqs = AmazonSQSClient                                                 <i class="conum" data-value="6"></i><b>(6)</b>
            .builder()
            .withEndpointConfiguration(localstack.getEndpointConfiguration(SQS))
            .withCredentials(localstack.defaultCredentialsProvider)
            .build()

        context = ApplicationContext.build('aws.sqs.queue': TEST_QUEUE).build()         <i class="conum" data-value="7"></i><b>(7)</b>
        context.registerSingleton(AmazonSQS, sqs)
        context.start()

        service = context.getBean(SimpleQueueService)                                   <i class="conum" data-value="8"></i><b>(8)</b>
    }

    // tests

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the specification with <code>@Testcontainers</code> to let Spock manage the Testcontainers for you</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@RestoreSystemProperties</code> will guarantee that system properties will be restore after the test</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with SQS support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code>, <code>@AutoCleanup</code> guarantees closing the context after the tests</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Disable CBOR protocol for SQS (not supported by the mock implementation)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Create <code>AmazonSQS</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Prepare the application context with required properties and service using LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>You can obtain instance of <code>SimpleQueueService</code> from the context</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">class SimpleNotificationServiceTest {

    public ApplicationContext context;                                                  <i class="conum" data-value="1"></i><b>(1)</b>

    public SimpleQueueService service;

    @Rule
    public LocalStackContainer localstack = new LocalStackContainer("0.8.10")           <i class="conum" data-value="2"></i><b>(2)</b>
        .withServices(SQS);

    @Before
    public void setup() {
        System.setProperty("com.amazonaws.sdk.disableCbor", "true");                    <i class="conum" data-value="3"></i><b>(3)</b>

        AmazonSQS amazonSQS = AmazonSQSClient                                           <i class="conum" data-value="4"></i><b>(4)</b>
            .builder()
            .withEndpointConfiguration(localstack.getEndpointConfiguration(SQS))
            .withCredentials(localstack.getDefaultCredentialsProvider())
            .build();


        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();                               <i class="conum" data-value="5"></i><b>(5)</b>
        properties.put("aws.sqs.queue", TEST_QUEUE);


        context = ApplicationContext.build(properties).build();                         <i class="conum" data-value="6"></i><b>(6)</b>
        context.registerSingleton(AmazonSQS.class, amazonSQS);
        context.start();

        service = context.getBean(SimpleQueueService.class);
    }

    @After
    public void cleanup() {
        System.clearProperty("com.amazonaws.sdk.disableCbor");

        if (context != null) {
            context.close();                                                            <i class="conum" data-value="7"></i><b>(7)</b>
        }
    }

    // tests

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Prepare the reference to the <code>ApplicationContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create an instance of <code>LocalStackContainer</code> with SQS support enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable CBOR protocol for SQS (not supported by the mock implementation)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <code>AmazonSQS</code> client using the LocalStack configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Prepare required properties</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Prepare the application context with required properties and service LocalStack</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Close the application context after the test</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_security_token_service_sts"><a class="anchor" href="#_security_token_service_sts"></a>1.8. Security Token Service (STS)</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The AWS Security Token Service (STS) is a web service that enables you to request temporary, limited-privilege credentials for AWS Identity and Access Management (IAM) users or for users that you authenticate (federated users).</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides basic support for Amazon STS using <a href="#_security_token_service">Security Token Service</a></p>
</div>
<div class="sect4">
<h5 id="_installation_8"><a class="anchor" href="#_installation_8"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-sts:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-sts&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_security_token_service"><a class="anchor" href="#_security_token_service"></a>Security Token Service</h5>
<div class="paragraph">
<p><code>SecurityTokenService</code> provides only one method (with multiple variations) to create credentials
which assumes usage of a certain IAM role.</p>
</div>
<div class="paragraph">
<p>Following example shows how to create credentials for assumed role.</p>
</div>
<div class="listingblock primary">
<div class="title">Assume Role</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="groovy">service.assumeRole('session', 'arn:::my-role', 360) {
    externalId = '123456789'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please, see <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/sts/SecurityTokenService.html">SecurityTokenService</a> for the full reference.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_7"><a class="anchor" href="#_testing_7"></a>Testing</h5>
<div class="paragraph">
<p>It is recommended just to mock the <code>SecurityTokenService</code> in your tests as it only contains single abstract method.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_websockets_for_api_gateway"><a class="anchor" href="#_websockets_for_api_gateway"></a>1.9. WebSockets for API Gateway</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In a WebSocket API, the client and the server can both send messages to each other at any time. Backend servers can easily push data to connected users and devices, avoiding the need to implement complex polling mechanisms.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This library provides components for easy handling of incoming WebSocket proxied events as well as for sending
messages back to the clients</p>
</div>
<div class="sect4">
<h5 id="_installation_9"><a class="anchor" href="#_installation_9"></a>Installation</h5>
<div class="listingblock primary">
<div class="title">Gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code>compile 'com.agorapulse:micronaut-aws-sdk-ag-ws:1.3.7.2'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.agorapulse&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-sdk-ag-ws&lt;/artifactId&gt;
    &lt;version&gt;1.3.7.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_5"><a class="anchor" href="#_configuration_5"></a>Configuration</h5>
<div class="paragraph">
<p>No configuration is required but some of the configuration properties may be useful for you.</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight nowrap"><code data-lang="yaml">aws:
  websocket:
    region: sa-east-1
    connections:
      url: https://abcefgh.execute-api.eu-west-1.amazonaws.com/test/@connections        <i class="conum" data-value="1"></i><b>(1)</b>

# Java Only
micronaut:
  function:
    name: lambda-echo-java                                                              <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can specify the default connections URL for <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSender.html">MessageSender</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If you are creating Java functions don&#8217;t forget to specify the function&#8217;s name for deployments</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSender.html">MessageSender</a> bean
is only present in the context if <code>aws.websocket.connectins.url</code> configuration property is present.Use <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSenderFactory.html">MessageSenderFactory</a>
If you want to create <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSender.html">MessageSender</a>
manually using URL which is not predefined.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_usage"><a class="anchor" href="#_usage"></a>Usage</h5>
<div class="paragraph">
<p><a href="https://github.com/aws/aws-lambda-java-libs/tree/master/aws-lambda-java-events">AWS SDK Lambda Events library</a> does not contain the events dedicated to WebSocket API Gateway yet.
You can use <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/WebSocketConnectionRequest.html">WebSocketConnectionRequest</a>
as an argument to function handling connection and disconnection of the WebSocket and <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/WebSocketRequest.html">WebSocketRequest</a> for handling
incoming messages.</p>
</div>
<div class="paragraph">
<p><strong>The following examples assume that you have created function using <code>mn create-function</code> command.</strong></p>
</div>
<div class="paragraph">
<p>The simplest example is a echo method can be used to handle all the incoming events and reply to the incoming messages and also
publishes to SNS:</p>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package com.agorapulse.micronaut.aws.apigateway.ws

import com.agorapulse.micronaut.aws.apigateway.ws.event.EventType
import com.agorapulse.micronaut.aws.apigateway.ws.event.WebSocketRequest
import com.agorapulse.micronaut.aws.apigateway.ws.event.WebSocketResponse
import groovy.transform.Field

import javax.inject.Inject

@Inject @Field MessageSenderFactory factory                                             <i class="conum" data-value="1"></i><b>(1)</b>
@Inject @Field TestTopicPublisher publisher                                             <i class="conum" data-value="2"></i><b>(2)</b>

WebSocketResponse lambdaEcho(WebSocketRequest event) {                                  <i class="conum" data-value="3"></i><b>(3)</b>
    MessageSender sender = factory.create(event.requestContext)                         <i class="conum" data-value="4"></i><b>(4)</b>
    String connectionId = event.requestContext.connectionId                             <i class="conum" data-value="5"></i><b>(5)</b>

    switch (event.requestContext.eventType) {
        case EventType.CONNECT:                                                         <i class="conum" data-value="6"></i><b>(6)</b>
            // do nothing
            break
        case EventType.MESSAGE:                                                         <i class="conum" data-value="7"></i><b>(7)</b>
            String message = "[$connectionId] ${event.body}"
            sender.send(connectionId, message)
            publisher.publishMessage(connectionId, message)
            break
        case EventType.DISCONNECT:                                                      <i class="conum" data-value="8"></i><b>(8)</b>
            // do nothing
            break
    }

    return WebSocketResponse.OK                                                         <i class="conum" data-value="9"></i><b>(9)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Factory to create <code>MessageSender</code> if we want to reply to the message immediately</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Service to publish to SNS to forward the message</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/WebSocketRequest.html">WebSocketRequest</a> can handle any incoming event</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSender.html">MessageSender</a> for current client</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>connectionId</code> is unique identifier of the client</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>CONNECT</code> event signals new client has been connected</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>MESSAGE</code> event signals new incoming message</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><code>DISCONNECT</code> event signals client has been disconnected</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The method must always return <code>WebSocketResponse.OK</code> to signal success</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package com.agorapulse.micronaut.aws.apigateway.ws;

import com.agorapulse.micronaut.aws.apigateway.ws.event.WebSocketRequest;
import com.agorapulse.micronaut.aws.apigateway.ws.event.WebSocketResponse;
import io.micronaut.function.FunctionBean;

import java.util.function.Function;

@FunctionBean("lambda-echo-java")
public class LambdaEchoJava implements Function&lt;WebSocketRequest, WebSocketResponse&gt; {

    private final MessageSenderFactory factory;                                         <i class="conum" data-value="1"></i><b>(1)</b>
    private final TestTopicPublisher publisher;                                         <i class="conum" data-value="2"></i><b>(2)</b>

    public LambdaEchoJava(MessageSenderFactory factory, TestTopicPublisher publisher) {
        this.factory = factory;
        this.publisher = publisher;
    }

    @Override
    public WebSocketResponse apply(WebSocketRequest event) {                            <i class="conum" data-value="3"></i><b>(3)</b>
        MessageSender sender = factory.create(event.getRequestContext());               <i class="conum" data-value="4"></i><b>(4)</b>
        String connectionId = event.getRequestContext().getConnectionId();              <i class="conum" data-value="5"></i><b>(5)</b>

        switch (event.getRequestContext().getEventType()) {
            case CONNECT:                                                               <i class="conum" data-value="6"></i><b>(6)</b>
                // do nothing
                break;
            case MESSAGE:                                                               <i class="conum" data-value="7"></i><b>(7)</b>
                String message = "[" + connectionId + "] " + event.getBody();
                sender.send(connectionId, message);
                publisher.publishMessage(connectionId, message);
                break;
            case DISCONNECT:                                                            <i class="conum" data-value="8"></i><b>(8)</b>
                // do nothing
                break;
        }

        return WebSocketResponse.OK;                                                    <i class="conum" data-value="9"></i><b>(9)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Factory to create <code>MessageSender</code> if we want to reply to the message immediately</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Service to publish to SNS to forward the message</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/WebSocketRequest.html">WebSocketRequest</a> can handle any incoming event</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSender.html">MessageSender</a> for current client</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>connectionId</code> is unique identifier of the client</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>CONNECT</code> event signals new client has been connected</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>MESSAGE</code> event signals new incoming message</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><code>DISCONNECT</code> event signals client has been disconnected</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The method must always return <code>WebSocketResponse.OK</code> to signal success</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the function is ready you can deploy the function to AWS Lambda and setup the new API Gateway with WebSocket API</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/new-websocket-api.png" alt="new websocket api">
</div>
<div class="title">Figure 1. Create new WebSocket API</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/new-websocket-route.png" alt="new websocket route">
</div>
<div class="title">Figure 2. Create WebSocket API Routes</div>
</div>
<div class="paragraph">
<p>Another example is a simple AWS Lambda function to react to any of events supported by AWS Lambda and push to WebSocket clients.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no support for routing at the moment, but you can get the matched route from
<code>event.requestContext.routeKey</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package com.agorapulse.micronaut.aws.apigateway.ws

import com.amazonaws.AmazonClientException
import com.amazonaws.services.lambda.runtime.events.SNSEvent
import groovy.transform.Field

import javax.inject.Inject

@Inject @Field MessageSender sender                                                     <i class="conum" data-value="1"></i><b>(1)</b>

void notify(SNSEvent event) {                                                           <i class="conum" data-value="2"></i><b>(2)</b>
    event.records.each {
        try {
            sender.send(it.SNS.subject, "[SNS] $it.SNS.message")                        <i class="conum" data-value="3"></i><b>(3)</b>
        } catch (AmazonClientException ignored) {
            // can be gone                                                              <i class="conum" data-value="4"></i><b>(4)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>MessageSender</code> can be injected if you specify <code>aws.websocket.connnections.url</code> configuration property</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can for example react on records published into Simple Notification Service</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Send message to the client (in previous example the <code>connectionId</code> was set to the <code>subject</code> of the SNS record)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the client is already disconnected then <code>AmazonClientException</code> may occur</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package com.agorapulse.micronaut.aws.apigateway.ws;

import com.amazonaws.AmazonClientException;
import com.amazonaws.services.lambda.runtime.events.SNSEvent;
import io.micronaut.function.FunctionBean;

import java.util.function.Consumer;

@FunctionBean("notification-handler")
public class NotificationHandler implements Consumer&lt;SNSEvent&gt; {

    private final MessageSender sender;                                                 <i class="conum" data-value="1"></i><b>(1)</b>

    public NotificationHandler(MessageSender sender) {
        this.sender = sender;
    }

    @Override
    public void accept(SNSEvent event) {                                                <i class="conum" data-value="2"></i><b>(2)</b>
        event.getRecords().forEach(it -&gt; {
            try {
                String connectionId = it.getSNS().getSubject();
                String payload = "[SNS] " + it.getSNS().getMessage();
                sender.send(connectionId, payload);                                     <i class="conum" data-value="3"></i><b>(3)</b>
            } catch (AmazonClientException ignored) {
                // can be gone                                                          <i class="conum" data-value="4"></i><b>(4)</b>
            }
        });
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>MessageSender</code> can be injected if you specify <code>aws.websocket.connnections.url</code> configuration property</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can for example react on records published into Simple Notification Service</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Send message to the client (in previous example the <code>connectionId</code> was set to the <code>subject</code> of the SNS record)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the client is already disconnected then <code>AmazonClientException</code> may occur</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to publish to the WebSockets using <a href="https://agorapulse.github.io/micronaut-aws-sdk/api/com/agorapulse/micronaut/aws/apigateway/ws/MessageSender.html">MessageSender</a>
your Lambda function&#8217;s role must have following permissions (preferably constrained just your API resource):</p>
</div>
<div class="listingblock">
<div class="title">ExecuteApiFullAccess Policy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="JSON">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": "execute-api:*",
            "Resource": "*"
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_8"><a class="anchor" href="#_testing_8"></a>Testing</h5>
<div class="paragraph">
<p>You can very easily mock any of the interfaces. Create request event manually and follow
<a href="http://guides.micronaut.io/micronaut-function-aws-lambda/guide/index.html#functiontests">the guide to test functions with Micronaut</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_6"><a class="anchor" href="#_configuration_6"></a>1.10. Configuration</h4>
<div class="paragraph">
<p>See the configuration sections for particular services.</p>
</div>
<div class="paragraph">
<p>Following services support configuring <code>region</code> and <code>endpoint</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CloudWatch</p>
</li>
<li>
<p>DynamodDB</p>
</li>
<li>
<p>Kinesis</p>
</li>
<li>
<p>S3</p>
</li>
<li>
<p>SES</p>
</li>
<li>
<p>SNS</p>
</li>
<li>
<p>SQS</p>
</li>
<li>
<p>STS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, to configure region for DynamoDB you can add following settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">aws:
  dynamodb:
    region: us-east-1
    endpoint: http://localhost:8000</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_for_api_gateway_proxy"><a class="anchor" href="#_micronaut_for_api_gateway_proxy"></a>2. Micronaut for API Gateway Proxy</h3>
<div class="paragraph">
<p>API Gateway Lambda Proxy support for Micronaut has been replaced by an official suport
<a href="https://micronaut-projects.github.io/micronaut-aws/latest/guide/#apiProxy">Micronaut AWS API Gateway Support</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_grails"><a class="anchor" href="#_micronaut_grails"></a>3. Micronaut Grails</h3>
<div class="paragraph">
<p>Micronaut Grails package has been moved into <a href="https://agorapulse.github.io/micronaut-grails">own repository</a>.</p>
</div>
</div>
<div class="sect1">
<h2 id="_links"><a class="anchor" href="#_links"></a>1. Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="api/index.html" target="_blank" rel="noopener">Javadoc</a></p>
</div>
<div class="paragraph">
<p><a href="api-html/index.html" target="_blank" rel="noopener">Source</a></p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.3.7.2<br>
Last updated 2020-11-03 12:07:50 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js"></script>
</body>
</html>